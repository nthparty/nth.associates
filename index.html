<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Nth Party, Ltd.">
    <meta name="author" content="Nth Party, Ltd.">
    <title>Nth Party | nth.associates</title>
    <link href="//fonts.googleapis.com/css2?family=Montserrat:wght@500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css"
          integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
    <script>
var favIcon = "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";
var docHead = document.getElementsByTagName('head')[0];
var newLink = document.createElement('link');
newLink.rel = 'shortcut icon';
newLink.type = 'image/x-icon';
newLink.href = 'data:image/png;base64,'+favIcon;
docHead.appendChild(newLink);
    </script>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YYFNCX1979"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', "G-YYFNCX1979");
    </script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css"
          integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
            integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.7.2/min/dropzone.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.7.2/basic.min.css" rel="stylesheet">
    <script src="libsodium-wrappers-sumo.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.8.2/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.8.2/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.9.1/underscore-min.js"></script>
    <script src="https://unpkg.com/papaparse@latest/papaparse.min.js"></script>
    <style>
html { height:100vh; font-family:'Montserrat',sans-serif; font-size:14px; }
body { display:flex; flex-direction:column; min-height:100vh; }

body > #topbar { border-bottom:1px solid #e5e5e5; }
body > #topbar > #title { white-space:nowrap; }
body > #topbar > #title > #logo { display:inline-block; margin-top:-30px; padding-right:10px; margin-right:10px; border-right:1px solid #3d1733; cursor:pointer; }
body > #topbar > #title > #name { display:inline-block; font-size:25px; color:#d49d48; position:relative; top:3px; font-family:'Montserrat',sans-serif; cursor:pointer; }
body > #topbar > #title > #name > b > sub { padding-left:3px; font-size:12px; color:#317b82; }
body > #topbar > nav > .tagline { margin-left:60px; font-family:'Montserrat',sans-serif; font-size:17px; color:#3d1733; }

body > .main { margin-bottom:60px; }
body > .container { max-width:1160px; }
body > .container > .card-deck > .card { min-width:330px; border-bottom-left-radius:20px; border-top-right-radius:20px; }
body > .container > .card-deck > .card a { color:#d49d48; }
body > .container > .card-deck > .card a:hover { color:#d49d48; }
body > .container > .card-deck > .card > .card-header { padding-top:16px; border-top:1px solid #B092A8; border-left:1px solid #B092A8; border-right:1px solid #B092A8; border-bottom:1px solid #CCCCCC; border-top-right-radius:20px; background-color:#EEEEEE; text-align:left; }
body > .container > .card-deck > .card > .card-header h4 { margin-bottom:4px; font-family:'Montserrat',sans-serif; font-size:20px; color:#d49d48; }
body > .container > .card-deck > .card > .card-header h4 .card-header-step-check { display:none; color:#317b82; font-weight:bold; }
body > .container > .card-deck > .card > .card-header h4 .card-header-step-warning { display:none; color:#FF0000; font-weight:bold; }
body > .container > .card-deck > .card > .card-header h5 { margin-bottom:5px; font-family:'Montserrat',sans-serif; font-size:19px; color:#3d1733; }
body > .container > .card-deck > .card > .card-header h5 span { font-size:20px; color:#3d1733; }
body > .container > .card-deck > .card > .card-header table { width:100%; }
body > .container > .card-deck > .card > .card-header td { padding-left:6px; padding-right:6px; text-align:center; vertical-align:middle; }
body > .container > .card-deck > .card > .card-header #drop-hidden-input { display:none; }
body > .container > .card-deck > .card > .card-body { border:1px solid #B092A8; border-top:0px solid #000000; border-bottom-left-radius:20px; padding-top:30px; padding-bottom:24px; background-color:#FFFFFF; text-align:center; }
body > .container > .card-deck > .card > .card-body-step { padding-bottom:110px; }
body > .container > .card-deck > .card > .card-body-step > img { height:90px; margin-top:8px; margin-bottom:30px; }
body > .container > .card-deck > .card > .card-body > .card-body-message { font-family:'Montserrat',sans-serif; font-size:14px; }
body > .container > .card-deck > .card > .card-body > .card-body-action { position:absolute; left:0px; bottom:26px; width:100%; text-align:center; }
body > .container > .card-deck > .card > .card-body > .card-body-action .button { padding:10px 24px 10px 24px; border-radius:5px; font-size:16px; }
body > .container > .card-deck > .card > .card-body > .card-body-action .button-disabled { cursor:not-allowed; }
body > .container > .card-deck > .card > .card-body #url-other { width:220px; margin-top:10px; display:none; }
body > .container > .card-deck > .card > .card-body #url-other-copy { display:none; }
body > .container > .card-deck > .card > .card-body .percentage { display:block; margin-bottom:6px; font-size:28px; }
body > .container > .card-deck > .card > .card-body .count { display:block; font-size:13px; }
body > .container > .card-deck > .card > .card-body > .sheet { display:inline-block; margin-top:10px; }
body > .container > .card-deck > .card > #card-other { background-color:#E5E3E7; }
body > .container > .card-deck > .card > .card-body .sheet-self { display:none; }
body > .container > .card-deck > .card > .card-body > #preview { display:none; text-align:middle; }
body > .container > .card-deck > .card > .card-body > #preview > table { display:inline; }
body > .container > .card-deck > .card > .card-body > #preview > table > tr > td { border:1px solid #CCCCCC; padding:0px 4px 0px 4px; font-size:11px; }
body > .container > .card-deck > .card > .card-body > #preview > table .row-number { background-color:#EEEEEE; padding:0px 16px 0px 16px; font-size:14px; }
body > .container > .card-deck > .card > .card-body > #preview > table .row-operation { background-color:#EEEEEE; padding:0px 0px 0px 0px; font-size:10px; }
body > .container > .card-deck > .card > .card-body > #preview > table .row-operation div { padding:5px 16px 5px 16px; }
body > .container > .card-deck > .card-request-access { display:none; }
body > .container > .card-deck > .card-request-access .card-body .card-body-message { font-size:16px; }
body > .container > .card-deck > .card-invalid { display:none; }
body > .container > .card-deck > .card-invalid a { color:#d49d48; }
body > .container > .card-deck > .card-invalid a:hover { color:#d49d48; }
body > .container > .card-deck > .card-invalid .card-body .card-body-message { font-size:16px; }
body > .container > .card-deck > .card-offboard { display:none; font-family:'Montserrat',sans-serif; font-size:18px; color:#3d1733; }
body > .container > .card-deck > .card-offboard .card-body { margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px; }
body > .container > .card-deck > .card-offboard table {  margin:0px 0px 0px 0px; }
body > .container > .card-deck > .card-offboard .card-offboard-message-cell { padding:30px; text-align:left; vertical-align:top; }
body > .container > .card-deck > .card-offboard .card-offboard-message-cell-bullets { width:55%; vertical-align:top; }
body > .container > .card-deck > .card-offboard .card-offboard-message-cell p { font-size:22px; }
body > .container > .card-deck > .card-offboard .card-offboard-message-cell-signup p { margin-bottom:30px; }
body > .container > .card-deck > .card-offboard .card-offboard-message-cell-signup input[type=text] { width:320px; }
body > .container > .card-deck > .card-offboard .card-offboard-message-cell li { }
body > .container > .card-deck > .card-offboard .card-offboard-signup-email-form { margin-top:-22px; margin-bottom:8px; }
body > .container > .card-deck > .card-offboard .signup-thankyou { display:none; }
body > .container > .card-deck > .card-step-one { display:none; opacity:0.5; }
body > .container > .card-deck > .card-step-two { display:none; opacity:0.5; }
body > .container > .card-deck > .card-step-three { display:none; opacity:0.5; }
body > .container > .card-deck > .card-data { display:none; }
body > .container > .card-deck > .card-step-complete { opacity:0.5 !important; }
body > .container > .card-deck > .card-step-complete > .card-header { background-color:#BAD8D2; }
body > .container > .card-deck > .card-step-complete > .card-body { background-color:#D7EDE9; }
body > .container > .card-deck > .card-step-complete:hover { opacity:1 !important; }
body > .container > .card-deck > .card-step-complete:hover > .card-header { }
body > .container > .card-deck > .card-step-complete:hover > .card-body { }
body > .container > .card-deck > .card-step-warning > .card-header { background-color:#E3C6CC; }
body > .container > .card-deck > .card-step-warning > .card-body { background-color:#F6E3E7; }

body > footer { width:100%; margin:auto auto 0 auto; padding:16px; background-color:#3d1733; }
body > footer a { color:#d49d48; }
body > footer a:hover { color:#d49d48; }
body > footer > .container { width:100%; padding:0px; color:#d49d48; font-family:'Montserrat',sans-serif; }
body > footer .card-deck { margin-bottom:0px !important; }
body > footer .card { margin-bottom:0px !important; border:0px; background-color:#3d1733; }
body > footer .card-deck-copyright { height:40px; font-size:10px; }
body > footer .card-copyright { height:40px; }
body > footer .card-body-links { padding-top:8px; }
body > footer .card-body-links-internal { float:left; }
body > footer .card-body-links-external { float:right; }
body > footer .link { margin:0px 25px 0px 0px; white-space: nowrap; font-size:14px; }
body > footer .icon { margin:0px 15px 0px 0px; font-size:18px; }
body > footer .icon-last { margin:0px 0px 0px 0px; font-size:18px; }

.box-shadow { box-shadow:0 .25rem .75rem rgba(0, 0, 0, .05); }
label { display:inline; font-family:'Montserrat',sans-serif; font-size:14px; }
input { display:inline; font-size:14px; padding:3px; }
input:disabled { cursor:not-allowed; }
button { display:inline; padding:5px 4px 3px 4px; border:1px solid #333333; background-color:#3d1733; color:#FFFFFF; font-family:'Montserrat',sans-serif; font-size:14px; font-size:14px; }
button:hover { background-color:#d49d48; }
.button { font-family:'Montserrat',sans-serif; font-size:14px; background-color:#3d1733; color:#FFFFFF; padding:5px 10px 3px 10px; border:1px solid #727577; }
.button:hover { background-color:#d49d48; }
.button:disabled, .button[disabled] { background-color:#787878; color:#DDDDDD; }
input[type=checkbox] { margin:8px; }
.noselect {
  -webkit-touch-callout:none; /* iOS Safari */
    -webkit-user-select:none; /* Safari */
     -khtml-user-select:none; /* Konqueror HTML */
       -moz-user-select:none; /* Old versions of Firefox */
        -ms-user-select:none; /* Internet Explorer/Edge */
            user-select:none; /* Non-prefixed version, currently
                                 supported by Chrome, Edge, Opera and Firefox */
}
#data-preview-description { margin-top:-7px; margin-bottom:7px; }

.data_op_domain { background-color:#89DEDB; }
.data_op_join { background-color:#FFDFAA; }
.data_op_groupby { background-color:#dca3cd; }
.data_checkbox_cell { padding:0px; cursor:pointer; }
.data_checkbox_cell > div { display:flex; width:100%; min-height:50px; }
.data_checkbox_cell > div > input { margin:auto; }
.data_cell { vertical-align:bottom; }
.exclude-first-row-toggle-div { margin-bottom:-7px; }
.exclude-first-row-toggle-div > table > tr > td { border:0px; text-align:left; }
.exclude-first-row-toggle-div > table input { margin:0px; cursor:pointer; }
.exclude-first-row-toggle-div > table label { padding-right:3px; font-size:8px; cursor:pointer; }
.first-row-checkbox-label { padding-bottom:7px; }
.data_row_first_cell_excluded { background-color:#EEEEEE !important; }

.tooltip-arrow { background-color:#3d1733; cursor:pointer; }
.tooltip > .tooltip-inner { padding:12px; background-color:#3d1733; font-family:'Montserrat',sans-serif; font-size:10px; cursor:pointer; }

.modal { height:100%; }
.modal #iframe-terms-and-policies { margin:0px 16px 70px 16px; border:1px #3d1733 solid; }
.modal-container-lg > .modal-dialog { display:table; position:relative; height:100%; margin:0 auto; }
.modal-container-lg > .modal-dialog > .modal-content { min-width:400px; height:100%; border:none; background-color:transparent; }
.modal-container-lg > .modal-dialog > .modal-content > table { height:100%; }
.progress { display:none; height:30px; width:100%; }
.progress-bar { background-color:#d49d48; }
#progress-message { display:none; margin-top:10px; text-align:center; color:#FFFFFF; font-family:'Montserrat',sans-serif; font-size:16px; }
.modal-card-deck { display:none; }
.modal .card-deck > .card { min-width:500px; min-height:240px; border-bottom-left-radius:20px; border-top-right-radius:20px; border:0px; }
.modal .card-deck > .card > .card-header { padding-top:16px; border-top:1px solid #B092A8; border-left:1px solid #B092A8; border-right:1px solid #B092A8; border-bottom:0px solid #000000; border-top-right-radius:20px; background-color:#EEEEEE; text-align:left; }
.modal .card-deck > .card > .card-header h4 { margin-bottom:4px; font-family:'Montserrat',sans-serif; font-size:20px; color:#d49d48; }
.modal .card-deck > .card > .card-header h4 .card-header-step-check { display:none; color:#317b82; font-weight:bold; }
.modal .card-deck > .card > .card-header h4 .card-header-step-warning { display:none; color:#FF0000; font-weight:bold; }
.modal .card-deck > .card > .card-header h5 { font-family:'Montserrat',sans-serif; font-size:20px; color:#3d1733; }
.modal .card-deck > .card > .card-header h5 span { font-size:20px; color:#3d1733;  }
.modal .card-deck > .card > .card-header table { width:100%; }
.modal .card-deck > .card > .card-header td { padding-left:6px; padding-right:6px; text-align:center; vertical-align:middle; }
.modal .card-deck > .card > .card-body { border:1px solid #B092A8; border-top:0px solid #000000; border-bottom-left-radius:20px; padding-top:30px; padding-bottom:24px; background-color:#FFFFFF; text-align:center; }
.modal .card-deck > .card > .card-body > .card-body-message { font-family:'Montserrat',sans-serif; font-size:14px; }
.modal .card-deck > .card > .card-body > .card-body-action { position:absolute; left:0px; bottom:26px; width:100%; text-align:center; }
.modal .card-deck > .card > .card-body > .card-body-action .button { padding:10px 24px 10px 24px; border-radius:5px; font-size:16px; }
.modal .card-deck > .card > .card-body > .card-body-action .button-disabled { cursor:not-allowed; }

@media all and (max-width:1096px) {
  body > #topbar > nav > .tagline { font-size:14px; }
  body > .container > .card-deck > .card > .card-header h5 { font-size:18px; }
  body > .container > .card-deck > .card > .card-header h5 span { font-size:18px; }
  body > .container > .card-deck > .card-offboard .card-offboard-message-cell { display:none; }
  body > .container > .card-deck > .card-offboard table { margin:0px; }
  .card-copyright > .card-body { text-align:center; }
  footer .card-body-links-internal { display:block; float:none; width:100%; text-align:center; margin-bottom:30px; }
  footer .card-body-links-internal .link { margin-right:10px; margin-left:10px; font-size:12px; }
  footer .card-body-links-external { display:block; float:none; width:100%; text-align:center; }
}

@media all and (max-width:767px) {
  body > #topbar > nav > .tagline { display:none; }
  #topbar { padding-bottom:0px !important; }
}
    </style>
    <!--social-media-sharing-css-->
  </head>
  <body onload="app.initialize();">

    <!-- Loading/waiting/progress/warning/error/message modal. -->
    <div class="modal fade modal-container-lg" data-backdrop="static" data-keyboard="false" tabindex="-1" style="height:100%">
      <div class="modal-dialog modal-sm" style="height:100%">
        <div class="modal-content" style="height:100%">
          <table><tr><td>
            <div class="card-deck mb-3 text-center modal-card-deck">
              <div class="card mb-4 box-shadow">
                <div class="card-header">
                  <h4 class="noselect card-header-title"></h4>
                  <h5 class="noselect"><span class="card-header-subtitle"></span></h5>
                </div>
                <div class="card-body">
                  <div class="card-body-message noselect">
                    <div class="card-body-message-content">
                    </div>
                  </div>
                  <div class="card-body-action">
                    <input type="button" id="card-modal-action-button" class="button" value="Okay" onclick="app.modal.hide();"/>
                  </div>
                </div>
              </div>
            </div>

            <!--span class="fa fa-spinner fa-spin fa-3x"></span-->
            <div class="progress">
              <div id="progress-overall-bar" class="progress-bar progress-bar-striped progress-bar-animated"
                   role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width:0%">
              </div>
            </div>
            <div id="progress-message" class="noselect"></div>
          </td></tr></table>
        </div>
      </div>
    </div>

    <!-- Title and navigation menu. -->
    <div id="topbar" class="d-flex flex-column flex-md-row align-items-center p-3 px-md-4 mb-3 bg-white box-shadow">
      <h5 id="title" class="my-0 mr-md-auto font-weight-normal">
        <div id="logo" class="noselect" onclick="window.location = 'https://nthparty.com';">
          <img src="data:image/png;base64, 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" alt="Nth Party"/>
        </div>
        <div id="name" class="noselect" onclick="window.location = '/';"><b>nth.associates<sub id="version"></sub></b></div>
      </h5>
      <nav class="my-2 my-md-0 mr-md-3">
        <!-- <a class="p-2 text-dark" href="#">
        <input type="button" class="button" value="Clear all messages" onclick="app.clear_all_messages();"/>
        </a> -->
        <div class="tagline noselect">The easy and safe way to <b>enrich data</b> without decrypting it in the process.</div>
        <!--social-media-sharing-html-->
      </nav>
    </div>

    <!--<div class="px-3 py-3 pt-md-5 pb-md-4 mx-auto text-center">
      <h1 class="display-4">{Title}</h1>
      <p class="lead">{Subtitle}</p>
    </div>-->
    <br/><br/>

    <div class="container main">

      <div class="card-deck mb-3 text-center">
        <div class="card mb-4 box-shadow card-step-one">
          <div class="card-header">
            <h4 class="noselect">Step 1 <span class="card-header-step-check card-step-one-checkmark">&check;</span></h4>
            <h5 class="noselect"><span class="card-header-subtitle">Load and encrypt your data</span></h5>
          </div>
          <div class="card-body card-body-step">
            <img src="1.svg"/>
            <div id="drop-hidden-input"></div>
            <div class="card-body-message noselect">
              <div class="card-body-message-content">
                Choose data to contribute or use
                <select name="data-random" id="data-random">
                  <option value="" disabled selected>&lt;choose&gt;</option>
                </select>
                rows of simulated data.
              </div>
            </div>
            <div class="card-body-action">
              <form action="/" id="chooseFile">
                <div class="dz-default dz-message">
                  <button id="card-step-one-action-button" class="dz-button button" type="button">Click or drop CSV file</button>
                </div>
              </form>
            </div>
          </div>
        </div>
        <div class="card mb-4 box-shadow card-step-two">
          <div class="card-header">
            <h4 class="noselect">Step 2 <span class="card-header-step-check card-step-two-checkmark">&check;</span></h4>
            <h5 class="noselect"><span class="card-header-subtitle">Create and share partner link</span></h5>
          </div>
          <div class="card-body card-body-step">
            <img src="2.svg"/>
            <div class="card-body-message">
              <div id="card-body-message-contributor-container">
                <div class="card-body-message-content noselect">Create a URL that your partner can use to contribute their encrypted data.</div>
                <div>
                  <input type="text" id="url-other" name="url-other" readonly/>
                  <input id="url-other-copy" class="button" type="button" value="Copy" data-clipboard-target="#url-other"/>
                </div>
              </div>
            </div>
            <div class="card-body-action">
              <input type="button" id="card-step-two-action-button" class="button button-disabled" value="Create partner link" onclick="app.contribute();" disabled/>
            </div>
          </div>
        </div>
        <div class="card mb-4 box-shadow card-step-three">
          <div class="card-header">
            <h4 class="noselect">
               Step 3
               <span class="card-header-step-check card-step-three-checkmark">&check;</span>
               <span class="card-header-step-warning card-step-three-warning">&#9888;</span>
            </h4>
            <h5 class="noselect"><span class="card-header-subtitle">Analyze and enrich</span></h5>
          </div>
          <div class="card-body card-body-step">
            <img src="3.svg"/>
            <div class="card-body-message">
              <div class="card-body-message-content noselect"></div>
            </div>
            <div class="card-body-action">
              <input type="button" id="card-step-three-action-button" class="button button-disabled" value="Analyze and enrich" onclick="app.analyze();" disabled/>
            </div>
          </div>
        </div>
      </div>

      <div class="card-deck mb-3 text-center">
        <div class="card mb-4 box-shadow card-request-access">
          <div class="card-header">
            <h5 class="noselect">Sign up</h5><!-- Request access or a demo -->
          </div>
          <div class="card-body">
            <!--content-signup-->
          </div>
        </div>
        <div class="card mb-4 box-shadow card-invalid">
          <div class="card-header">
            <h5 class="noselect">Invalid session</h5><!-- Request access or a demo -->
          </div>
          <div class="card-body">
            <div class="card-body-message noselect">
              The URL you are using is not valid or the session associated with it has expired. Please contact the creator of the URL you are using or create a new session.
            </div>
          </div>
        </div>
        <div class="card mb-4 box-shadow card-offboard">
          <div class="card-header">
            <h4 class="noselect">Thank you for trying <b>nth.associates</b>!</h4>
            <h5 class="noselect">Let us know your ideas and share feedback</h5>
          </div>
          <div class="card-body">
            <table>
              <tr>
                <td class="card-offboard-message-cell card-offboard-message-cell-bullets noselect">
                  <p>What are some use cases for measuring the overlap between sensitive data sets?</p>
                  <ul>
                    <li>Compare two marketing lists to see if there is customer overlap.</li>
                    <li>Evaluate similarity between list of acquirer and target customers before collaborating further.</li>
                    <li>Let members of your sales team securely provide a preview to prospects of the value of your data.</li>
                    <li>Make up your own use case and let us know!</li>
                  </ul>
                </td>
                <td class="card-offboard-message-cell card-offboard-message-cell-signup noselect">
                  <p>Please let us know what you think by taking <b><a href="https://nthparty.typeform.com/to/CwCzHIGx">a short survey</a></b>.</p>
                  <p>Sign up to receive news and updates.</p>
                  <div class="card-offboard-signup-email-form">
                    <input type="text" id="signup-email" name="signup-email" placeholder="email@example.com"/>
                    <input id="signup-email-submit" class="button" type="button" value="Sign Up" onclick="app.signup();"/>
                  </div>
                  <p class="signup-thankyou">Thank you for your interest!</p>
                </td>
                <!--content-offboard-typeform-->
              </tr>
            </table>
          </div>
        </div>
        <div class="card mb-4 box-shadow card-data">
          <div class="card-header">
            <h5 id="card-data-header-content" class="noselect">Preview your data contribution</h5>
          </div>
          <div class="card-body">
            <div class="card-body-message noselect" id="data-preview-description">A preview of your data contribution will appear here.</div>
            <div class="sheet" id="sheet-self"></div>
            <div id="preview" class="noselect"></div>
          </div>
        </div>
      </div>
    </div>

    <footer class="text-muted">
      <div class="container">
        <div class="card-deck mb-3">
          <div class="card mb-4">
            <div class="card-body card-body-links">
              <div class="card-body-links-internal">
              <span class="link"><b><a href="https://nthparty.com">Nth Party, Ltd.</a></b></span>
              <span class="link"><a href="javascript:void(0)" onclick="app.modal.showTermsOfService();">Terms of Service</a></span>
              <span class="link"><a href="javascript:void(0)" onclick="app.modal.showPrivacyPolicy();">Privacy Policy</a></span>
              <span class="link"><a href="https://nthparty.com/contact-us">Contact Us</a></span>
              </div>
              <div class="card-body-links-external">
                <span class="icon"><a href="https://linkedin.com/company/nth-party"><i class="fab fa-linkedin"></i></a></span>
                <span class="icon"><a href="https://twitter.com/nthparty"><i class="fab fa-twitter"></i></a></span>
                <span class="icon"><a href="https://medium.com/nthparty"><i class="fab fa-medium"></i></a></span>
                <span class="icon-last"><a href="https://github.com/nthparty"><i class="fab fa-github"></i></a></span>
              </div>
            </div>
          </div>
        </div>
        <div class="card-deck mb-3 card-deck-copyright">
          <div class="card mb-4 card-copyright">
            <div class="card-body noselect">
              &copy; Copyright 2021 Nth Party, Ltd. All rights reserved.
            </div>
          </div>
        </div>
      </div>
    </footer>

    <!-- Bootstrap core JavaScript placed at the end of the document for faster loading. -->
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"
            integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
    <script>
/*
 * API for interacting with Google Analytics
 */

function Analytics() {

  this.currentTime = Date.now()

  function fileUploadSuccess(complete, numRows) {
    if (complete) {
      gtag("event", "file_upload_success", {
        "event_category": "file_upload",
        "event_type": "fullLoad",
        "elapsed": Date.now() - self.currentTime,
        "num_rows": numRows
      });
    } else {
      gtag("event", "file_upload_success", {
        "event_category": "file_upload",
        "event_type": "partialLoad",
        "elapsed": Date.now() - self.currentTime,
        "num_rows": numRows
      });
    }
  }

  function fileUploadFail(cause) {
    gtag("event", "file_upload_fail", {
      "event_category": "file_upload",
      "event_type": cause
    })
  }

  function contributeData(roles) {
    gtag("event", "contribute_data", {
      "event_category": "contribute",
      "elapsed": Date.now() - self.currentTime,
      "roles": roles
    });
  }

  function copyContributorUrl() {
    gtag("event", "copy_contributor_link", {
      "event_category": "copy_link"
    });
  }

  function analyzeData(roles) {
    gtag("event", "analyze_data", {
      "event_category": "analyze",
      "elapsed": Date.now() - self.currentTime,
      "roles": roles
    })
  }

  /* Publicly accessible methods. */
  let exports_ = {};
  exports_.fileUploadSuccess = fileUploadSuccess;
  exports_.fileUploadFail = fileUploadFail;
  exports_.contributeData = contributeData;
  exports_.copyContributorUrl = copyContributorUrl;
  exports_.analyzeData = analyzeData;
  return exports_;
}

/*
 * Overall application.
 */
function App(config) {

  /* Dependencies. */

  var require = function (m) { if (!(m in window)) throw new Error('cannot load ' + m); };

  // External.
  require('jQuery');
  require('ClipboardJS');
  require('Dropzone');
  require('Papa');
  require('sodium');
  require('firebase');

  // Internal.
  require('Session');
  require('State');
  require('URLs');
  require('IDs');
  require('Data');
  require('Sheets');
  require('CSV');
  require('Cards');
  require('Buttons');
  require('Modal');
  require('Progress');
  require('Channel');
  require('Analytics');

  /* Internal object attributes. */

  this.config = config;
  this.io = null;
  this.sheets = new Sheets(this);
  this.collection = null;
  this.progress = new Progress();
  this.session = null;
  this.state = null;
  this.cards = null;
  this.buttons = null;
  this.modal = null;
  this.url = null;

  /* Methods. */

  var self = this; // Self-reference for use in method implementations.

  this.mapAsyncWithProgress = function (fn, arr, index, arr_, portion) {
    index = (index == null) ? 0 : index;
    arr_ = (arr_ == null) ? [] : arr_;
    var portion = (portion == null) ? 1000 : portion;
    var i = null;

    for (i = index; i < arr.length && (i - index) < portion; i++) {
      arr_.push(fn(arr[i], i));
    }
    self.progress.advanceByLength(i - index);

    return new Promise(function (resolve) {
      if (i < arr.length) {
        setTimeout(function () {
          self.mapAsyncWithProgress(fn, arr, i, arr_).then(resolve);
        }, 100);
      } else {
        resolve(arr_);
      }
    });
  };

  this.giveGetProgressSize = function (numRows) {
    /*
    Calculate the number of get() or give() calls will be made
    for a query based on number of rows passed.
     */
    let objectSize =
      (numRows * 43) +                          // 43 chars per row
      (numRows - 1) +                           // number of commas in output
      (numRows * 2) +                           // number of " chars in output
      64                                        // constant sized metadata in output
    return Math.ceil(objectSize / 128000);   // divide by msgBandwidth value
  }

  this.stages = async function (stage) {

    self.analytics.currentTime = Date.now();    // set start time for analytics
    var id_self = self.state.idSelf();
    var id_other = self.state.idOther();
    var roles = // Determine if this contributor is also a recipient.
      ["contributor"] + (self.state.resultsReceive() ? ["recipient"] : []);

    // Add the initial data from this contributor to the database if this
    // is the first time this function has been invoked.
    if (stage === 0) {

      // Reset the results panel.
      self.clear();

      // Initialize progress tracking modal.
      let data = self.state.dataSelf();
      let selfNumChunks = self.giveGetProgressSize(data.length);

      if (!roles.includes("recipient")) {
        let otherNumChunks = self.giveGetProgressSize(self.state.__dataOtherLength);
        self.progress.setLength(
          2 * data.length +
          self.state.__dataOtherLength +
          selfNumChunks +
          2 +
          otherNumChunks * 2 +
          1
        );
      } else {
        self.progress.setLength(
          2 * data.length +
          self.state.__dataOtherLength +
          selfNumChunks +
          2
        );
      }

      self.progress.message("Preparing data for encryption.");

      // Create a protocol session data structure and prepare
      // the data (i.e., transforming and hashing as necessary).
      self.session = new Session(self, self.state, roles);
      let prepared = await self.session.prepareSelfData(data);
      
      // Because deduplication may have reduced the total amount
      // of data, adjust the progress bar maximum length and
      // recalculate the current percentage. The user may see the
      // progress bar "jump" forward by some interval.
      self.progress.reduceLengthBy(
        2 * (data.length - self.session.data.points.length)
      );
      self.progress.reduceLengthBy(
        2 * (selfNumChunks - self.giveGetProgressSize(self.session.data.points.length))
      );

      // Encrypt the data and write first messages to database.
      let stepResult = await self.session.stepZero();
      self.progress.message("Contributing encrypted data.");
      await self.io.give({
        tag: "S0_" + id_other,
        msg: {
          "data": {
            "size":
              (stepResult.data.masked.length != null) ?
                stepResult.data.masked.length : (
                  (stepResult.data.keyed.length != null) ?
                    stepResult.data.keyed.length :
                    0
                )
          }
        },
        no_batching: false,
        update_progress: true
      })
      await self.io.give({
        tag: "S1_" + id_other,
        msg: stepResult,
        no_batching: false,
        update_progress: true
      })

      if (roles.includes("recipient")) {
        setTimeout(function () {
          // For the recipient, the protocol will continue when they click "Analyze".
          self.cards.message(
            ".card-step-three",
            "Once your partner has contributed, click <b>Analyze and enrich</b> to see the results."
          );
          self.buttons.disable("#card-step-two-action-button");
          self.cards.message(".card-step-two", "Send this URL to your data partner:");
          $("#url-other").css("display", "inline-block");
          $("#url-other-copy").css("display", "inline-block");
          self.modal.hide();
          self.progress.reset();
          self.analytics.contributeData(["contributor", "recipient"]);
        }, 500);
      } else {
        // Update the interface to indicate we are waiting
        // and begin polling for a response.
        self.progress.message("Operating on other contributor's encrypted data.");
        self.check_firebase_status_before_stage(1);
      }

    } else if (stage === 1) {

      // Check if the data is already posted.
      let messagePeek = await self.io.peek("S0_" + id_self);

      if (roles.includes("recipient") && !messagePeek) {
        self.cards.message(
          ".card-step-three",
          "Your partner has not yet contributed their encrypted data. Please try again later."
        );
        self.cards.warning(".card-step-three");
        self.progress.setPercent(100);
        self.modal.hide();
        self.progress.reset();
      }

      if (!roles.includes("recipient") || messagePeek) {
        // Obtain data from other contributor.
        // Set the progress bar length to capture all subsequent operations
        // on own and other party's data.
        if (roles.includes("recipient")) {
          // Retrieve and clear out the first message (which has validation and data size).
          // No need to update progress bar because it's always only one query
          let messageValidation = await self.io.get({tag:"S0_" + id_self, update_progress: false});
          let getStepOneSize = await self.io.get_size({tag: "S1_" + id_self});
          let getStepTwoSize = await self.io.get_size({tag: "S2_" + id_self});
          // Update progress bar range.
          self.progress.setLength(
            getStepOneSize +                  // For query against S1.
            getStepTwoSize +                  // For query against S2.
            messageValidation.data.size +     // For decoding in `stepOne`.
            messageValidation.data.size +     // For unmasking in `stepTwo`.
            self.session.data.points.length + // For projecting unmasked keyed points in `stepTwo`.
            messageValidation.data.size +     // For projecting unmasked keyed points in `stepTwo`.
            self.session.data.points.length   // For final intersection in `stepTwo`.
          );
        }
        let message = await self.io.get({tag: "S1_" + id_self, update_progress: true});

        // Key the masked data from the other contributor.
        let stepResult = await self.session.stepOne(message);

        if (roles.includes("recipient")) {
          // For the recipient, the protocol will continue.
          self.check_firebase_status_before_stage(2);
        } else {
          await self.io.give({
            tag: "S2_" + id_other,
            msg: stepResult,
            no_batching: false,
            update_progress: true
          })

          // For the contributor, the protocol is finished.
          self.cards.message(
            ".card-step-two",
            "Your encrypted data has been contributed to the secure analysis. <b>You may now close this page.</b>"
          );
          self.cards.completeAndRemain(".card-step-two", "#card-step-two-action-button");
          self.modal.hide();

          // Show offboarding card if directed by configuration to do so.
          if ("offboard" in self.config && self.config.offboard) {
            $(".card-data").hide();
            $(".card-offboard").show();
          }
          self.analytics.contributeData(["contributor"]);
        }
      }
    } else if (stage === 2) {
      // Obtain data from other contributor.
      let message = await self.io.get({tag: "S2_" + id_self, update_progress: true});
      let stepResult = await self.session.stepTwo(message);

      // We received a response but still need to compute the
      // intersection.
      self.progress.message("Computing the results of the analysis.");

      // If we have an intersection, display it.
      if (Array.isArray(stepResult.intersection)) {
        if (self.state.resultsQuantitative()) {
          const result_count = stepResult.count;
          const percentage = (100 * result_count) / self.session.data.points.length;
          self.cards.message(
            ".card-step-three",
            '<span class="percentage">' + percentage.toFixed(3) + "%</span>" +
            '<span class="count">' +
              "or <b>" + result_count + "</b> of the " +
              "<b>" + self.session.data.points.length + " unique</b> entries in your " +
              " data match entries in your partner's data" +
            '</span>' +
            // Include link to survey if directed to do so.
            (("analysisResultsFeedbackSurveyLink" in self.config &&
              self.config.analysisResultsFeedbackSurveyLink)
              ?
              ('<br/>Have feedback or ideas? ' +
                '<a href="https://nthparty.typeform.com/to/CwCzHIGx"><b>Tell us what you think!</b></a>')
              :
              ''
            )
          );
          self.buttons.disable("#url-other-copy");
          self.cards.completeAndRemain(".card-step-three", "#card-step-three-action-button");
          self.progress.setPercent(100);

          // Show offboarding card if directed by configuration to do so.
          if ("offboard" in self.config && self.config.offboard) {
            $(".card-data").hide();
            $(".card-offboard").show();
          }

          // Display the results.
          self.sheets.self.grouped(stepResult.intersection);

          // If grouping was requested, display counts of own data grouped
          // by values in grouping column.
          var columnGroupBy = self.data.columnGroupBy();
          if (columnGroupBy != null) {
            var mapping = {}, keys = [];
            for (var r = 0; r < stepResult.intersection.length; r++) {
              var key = stepResult.intersection[r][columnGroupBy];
              mapping[key] = (mapping[key] == null) ? 1 : mapping[key] + 1;
            }
            var group_counts = [];
            for (var key in mapping) {
              group_counts.push([key, mapping[key]]);
            }
            self.sheets.self.grouped(group_counts);
          }

        } else {
          self.sheets.other.data(stepResult.intersection);
        }
      }

      // Display whether the other contributor received data.
      if (stepResult.other.roles.includes("recipient")) {
        self.cards.message(
          ".card-step-three",
          "Other contributor has received the results."
        );
      } else {
        /*self.cards.message(
          ".card-step-three",
          "Other contributor did not request the results."
        );*/
      }

      // Update interface to indicate results are posted to interface.
      self.modal.hide();
      self.analytics.analyzeData(["contributor", "recipient"]);

    } // End if `stage` is `0` else if `1` else if `2`.
  }

  this.iframeResize = function () {
    var height = $(window).height(), width = $(window).width();
    $("#iframe-terms-and-policies").css("height", height * 0.3 | 0);
    $("#iframe-terms-and-policies").css("width", width * 0.6 | 0);
  };

  this.initialize = function () {
    // Add version subscript if it is for a preliminary version.
    if (["alpha", "beta"].includes(self.config.version)) {
      $("#version").html(self.config.version);
    }

    setTimeout(async function () {
      await sodium.ready;

      // Parameters: poll interval (ms), max items per query, maximum message size (KB).
      self.io = Channel(self, self.config.collection, 200, 1000, 128000);
      self.analytics = Analytics();

      // Create instance of URL interface.
      self.interfaceForURLs = new URLs(self);
      self.interfaceForIDs = new IDs(self);

      // Create instances of interface component APIs.
      self.cards = new Cards(self);
      self.buttons = new Buttons(self);
      self.data = new Data(self);
      self.csv = new CSV(self);
      self.modal = new Modal(self);

      // Ensure the URL is valid.
      if (!self.interfaceForURLs.validURL()) {
        self.invalid();
      }

      // Contributor may need to wait for the URL to be validated.
      if (self.interfaceForURLs.isContributorURL()) {
        self.modal.showProgress("Validating your session URL.", 25);
      }

      try {
        let decr = null;
        try {
          // Set up access to back-end infrastructure.
          const __key =
            ("key" in self.config) ?
            self.config.key :
            self.interfaceForURLs.authFromURL();
          const __storage = [
            'I8xyy-YSHleWq-RfrE7aq5_dDkjcqxQa6vxnnh1BJIguU9qCVcQIsg' +
            '_-e7wXaVtj_jMpzMvOUhWHAKkyiImKEBNXXRLYTLnMuY9TTMv2Yk2U' +
            'u1kMt-dmGXOhVMBIugSHKfJXHGt70Kc5lueVqi37S5uubybg8RZBON' +
            'bV5STRpp54ec1Cq0eMveW-hKZjyHFoQh-pVk44_BqYLaDQrHOg1qTq' +
            'KSTpC3mUSp9mPXy-2CZbq0NZernsWKKgMH-4430inHFpKhJrLOPAcg' +
            'MZOjl-cr88uipZFTDopjZJPFxeV6WTykzBEFyr7RNkFr7Q3UpCxj0l' +
            'hs-JWgXSo1Uwrjicf6ZdC1baihbL_QR3qtzGC7_AF4yuCl8ymFgr0G' +
            '7lNzrIncHvPJug2oJMDbjMJm4Y3jqImVXJJGmX1yHSGUFxxtOvQ68h' +
            'vcX2DoQSanFNNZuMTA8HuUaKQB0RYpdncTlgmho', 'hHPj5xRKAvr' +
            'SuuhtwIGJ9aXdQBKmRs_eT8'
          ];

          decr = sodium.crypto_aead_chacha20poly1305_decrypt(null,
            sodium.from_base64(__storage[0]), null, new Uint8Array(8),
            sodium.from_base64(__key + __storage[1])
          );

          const firebaseConfig = JSON.parse(sodium.to_string(decr));
          firebase.initializeApp(firebaseConfig);
          self.collection = firebase.database().ref().child(self.config.collection);

          // Contributor is waiting for session to be validated.
          if (self.interfaceForURLs.isContributorURL()) {
            self.progress.setPercent(50);
          }

        } catch (e) {
          $(".card-request-access").fadeIn();
          $(".card-step-one").remove();
          $(".card-step-two").remove();
          $(".card-step-three").remove();
          self.modal.hide();
        }
      } catch (e) {
        if (e.toString() === "Error: invalid input") {
          // Authentication failed.
          self.invalid();
          self.modal.hide();
        } else {
          // Something else went wrong.
          self.invalid();
          self.modal.hide();
        }
      }

      // Configure the UI component for choosing a CSV file.
      if ($("#chooseFile").length) {
        // time_elapsed in analytics will be set against this value
        self.analytics.currentTime = Date.now();
        var dropzone = new Dropzone("#chooseFile", {
          "autoProcessQueue": false,
          "autoQueue": false,
          "hiddenInputContainer": "#drop-hidden-input",
          "previewTemplate": '<span style="display:none"></span>',
          "createImageThumbnails": false
        });
        dropzone.on("addedfile", function(file) {
          // Display progress modal.
          self.modal.showProgress("Loading CSV file into browser.", 0);

          // Only allow CSV files to be loaded.
          if (!file.name.endsWith(".csv")) {
            self.analytics.fileUploadFail("fileNotCsv");
            self.modal.showCard(
              "Error",
              "Non-CSV file selected",
              "The selected file <b>" + file.name + "</b> is not a CSV file. " +
                 "Please select a valid CSV file."
            );
            return;
          }

          // Only allow CSV files to be loaded.
          if (file.size == 0) {
            self.analytics.fileUploadFail("fileEmpty");
            self.modal.showCard(
              "Error",
              "CSV file is empty",
              "The selected file <b>" + file.name + "</b> has no rows. " +
                 "Please select a CSV file that contains at least one row."
            );
            return;
          }

          // If maximum CSV file size is an expression string, evaluate it.
          if (!Number.isInteger(self.config.maximumCSVFileSize)) {
              var factors = self.config.maximumCSVFileSize.split("*");
              self.config.maximumCSVFileSize = 1;
              for (var i = 0; i < factors.length; i++) {
                  self.config.maximumCSVFileSize *= parseInt(factors[i].trim());
              }
          }

          // Limit maximum size of allowed CSVs.
          if (file.size > self.config.maximumCSVFileSize) {
            self.analytics.fileUploadFail("fileTooLarge");
            self.modal.showCard(
              "Error",
              "CSV file is too large",
              "The selected file <b>" + file.name + "</b> is over 50 MB in size. " +
                "Please select a smaller CSV file."
            );
            return;
          }

          // Load the file.
          var reader = new FileReader();
          reader.readAsText(file);
          reader.onload = function(event) {
            // Parse the CSV.
            var csvData = event.target.result.trim();
            var data = [], stepCount = 0, chunksParsed = 0;
            var capRows = self.config.maximumCSVRowCount, capReached = false;
            Papa.parse(
              csvData,
              {
                worker: true, // Disable if using `setTimeout()` approach.
                chunkSize: 1024 * 1024, // Disable if using `setTimeout()` approach.
                chunk: function (results, parser) {
                  if (results && results.data) {

                    stepCount += results.data.length;
                    if (stepCount > capRows) {
                      capReached = true;
                      let rowsLeft = capRows - data.length;
                      data.push.apply(data, results.data.slice(0, rowsLeft));
                      parser.abort();
                    } else {
                      chunksParsed++;
                      data.push.apply(data, results.data);
                      self.progress.setPercent(Math.ceil((100 * 1024 * 1024 * chunksParsed) / file.size));
                    }

                  }
                },
                complete: function (results) {
                  // Record a reference to the data and move on to the next step.
                  self.state.dataSelf(data);
                  self.cardStepTwo();

                  // Update the progress bar.
                  self.progress.setPercent(100);

                  // Display message if data has been cut off due to the
                  // cap on the number of rows being reached.
                  if (!capReached) {
                    self.analytics.fileUploadSuccess(true, stepCount);
                    self.modal.hide();
                  } else {
                    self.analytics.fileUploadSuccess(false, capRows);
                    self.modal.showCard(
                      "Warning",
                      "CSV Row Limit",
                      "Your selected CSV file <b>" + file.name + "</b>" +
                        " has more than " +capRows + " rows." +
                        " <b>Only the first " + capRows + " rows have been loaded.</b>"
                    );
                  }
                },
                error: function () {
                  self.analytics.fileUploadFail("fileParseError");
                  self.modal.showCard(
                    "Error",
                    "Loading and Parsing CSV File",
                    "There was an error loading or parsing the CSV file you chose."
                  );
                }
              }
            );
          };
          reader.onerror = function() {
            self.analytics.fileUploadFail("fileReadError");
            self.modal.showCard(
              "Error",
              "Cannot read file",
              "The selected file <b>" + file.name + "</b> cannot be read."
            );
          };
        });
      }

      // Contributor is waiting for session to be validated.
      if (self.interfaceForURLs.isContributorURL()) {
        self.progress.setPercent(75);
      }

      // Create an initial state, including IDs and tokens.
      self.state = new State(self);

      // Generate or parse participant identifiers.
      if (!self.interfaceForURLs.idsFromURL()) {
        self.state.idSelf(self.interfaceForIDs.idCreateRecipient());
      }

      // Determine participant role configuration.
      if (self.state.idSelf()[0] == 'r') { // This is an analysis-recipient/session-creator.

        // Set configuration to receive aggregate results.
        self.state.resultsReceive(true);
        self.state.resultsQuantitative(true);

        // Assign identifier to contributor.
        if (!self.interfaceForURLs.idsFromURL()) {
          self.state.idOther(self.interfaceForIDs.idCreateContributor());
        }

        // Build the contributor URL for sharing with contributor.
        if ($("#url-other").length) {
          document.getElementById("url-other").value = self.interfaceForURLs.contributorURL();
        }

        // Adjust and show cards and card content for this role.
        if (!self.interfaceForURLs.allowSimulatedFromURL()){
            self.cards.message(
              ".card-step-one",
              ('Choose CSV file to contribute to the analysis or ' +
                '<a id="simlink" href="javascript:void(0)" onclick="app.simulatedLinkClick();"><b>click here</b></a> ' +
                'to use sample data. ') +
              //"Choose a CSV file containing the data you are contributing to the analysis. " +
              ('By loading your data, you agree to the ' +
                '<a href="javascript:void(0)" onclick="app.modal.showTermsOfService();">Terms of Service</a>.')
            );
        }
        self.cards.activate(".card-step-one");
        self.cards.introduce([
          ".card-step-one",
          ".card-step-two",
          ".card-step-three"
        ]);

      } else { // This is a data contributor.

        // Ensure there is a session with data waiting for the contributor.
        let recipientDataPresent = await self.io.attempt("S0_" + self.state.idSelf());
        if (recipientDataPresent === false) {
          // There is no session or recipient data.
          self.invalid();

          // Hide session URL validation modal message.
          self.progress.setPercent(100);
          self.modal.hide();
        } else { // There is a session with encrypted recipient data.
          // Save the size of the session creator's data contribution.
          self.state.__dataOtherLength = recipientDataPresent.data.size;

          // Set configuration to receive no results.
          self.state.resultsReceive(false);
          self.state.resultsQuantitative(false);

          // Set the data contribution step button label.
          self.buttons.label("#card-step-two-action-button", "Contribute encrypted data");

          // Adjust and show cards and card content for this role.
          if (!self.interfaceForURLs.allowSimulatedFromURL()){
              self.cards.message(
                ".card-step-one",
              ('Choose CSV file to contribute to the analysis or ' +
                '<a id="simlink" href="javascript:void(0)" onclick="app.simulatedLinkClick();"><b>click here</b></a> ' +
                'to use sample data. ') +
              //"Choose a CSV file containing the data you are contributing to the analysis. " +
                'By loading your data, you agree to the <a href="javascript:void(0)" onclick="app.modal.showTermsOfService();">Terms of Service</a>.'
              );
          }
          self.cards.message(
            ".card-step-two",
            "You may contribute your encrypted data when you are ready by clicking below."
          );
          self.cards.subtitle(
            ".card-step-two",
            "Contribute your encrypted data"
          )
          self.cards.activate(".card-step-one");
          self.cards.introduce([
            ".card-step-one",
            ".card-step-two"
          ]);

          // Hide session URL validation modal message.
          self.progress.setPercent(100);
          self.modal.hide();
        }
      }

      // Input/output spreadsheets.
      $("#sheet-self").show();
      self.sheets.initialize();
      $("#sheet-self").hide();
      self.clear(); // Clear results output HTML elements.

      // // Database API wrapper.
      // self.io.initialize();

      // Button to copy contributor URL to clipboard.
      if ($("#url-other-copy").length) {
        var clipboard = new ClipboardJS("#url-other-copy");
        // Once the URL is copied, fade step cards as appropriate.
        clipboard.on('success', function(e) {
          self.analytics.copyContributorUrl();
          self.cards.complete(".card-step-two", "#card-step-two-action-button");
          self.cards.activate(".card-step-three");
          self.buttons.enable("#card-step-three-action-button");
        });
      }

      $(window).resize(function() {
        self.iframeResize();
      });
    }); // Wait for sodium to load.
  };

  this.clear = function () {
    self.cards.message(
      ".card-step-three",
      "Once your partner has contributed, click <b>Analyze</b> to see the results."
    );
    if (!self.state.resultsReceive()) {
      self.state.resultsQuantitative(false);
    }
  };

  this.cardStepTwo = function () {
    $("#data-random").prop("disabled", true);
    self.cards.complete(".card-step-one", "#card-step-one-action-button");
    self.cards.activate(".card-step-two");
    self.cards.introduce([".card-data"]);
    self.buttons.enable("#card-step-two-action-button");
  }

  this.simulated = function () {
    self.cardStepTwo();
  };

  this.simulatedLinkClick = function () {
    $("#simlink").prop("onclick", null).off("click");
    self.sheets.selfSelectRandomData('data500.json');
    self.clear();
    self.simulated();
  };

  this.contribute = function () {
    if (self.state.idOther() == null ||
        self.state.idOther().length != self.interfaceForIDs.idLength()) {
      // Should not occur if link is properly formatted.
    } else {
      self.modal.showProgress("Gathering data for encryption.", 0);
      setTimeout(async function () { self.check_firebase_status_before_stage(0); }, 250);
    }
  };

  this.analyze = function () {
    if (self.state.idOther() == null ||
        self.state.idOther().length != self.interfaceForIDs.idLength()) {
      // Should be an error.
    } else {
      self.modal.showProgress("Retrieving encrypted data for analysis.", 0);
      setTimeout(async function () { self.check_firebase_status_before_stage(1) }, 250);
    }
  };
  
  this.signup = async function () {
    self.modal.showProgress("Signing up...", 100);

    // Base64-encoded, encrypted email address string.
    var encrypted = sodium.to_base64(sodium.crypto_box_seal(
      sodium.from_string($("#signup-email").val()),
      sodium.from_base64("+kVkXT1ITinuylEIEtWjlP4JvyQjpE1l5/tELntDwGw=", 1)
    ), 1);

    await self.io.give({
      tag: "SIGNUP",
      msg: {"email": encrypted},
      update_progress: false
    });
    $("#signup-email").prop("disabled", true);
    $(".signup-thankyou").show();
    self.modal.hide();
  }

  this.invalid = function () {
    $(".card-invalid").fadeIn();
    $(".card-request-access").remove();
    $(".card-data").remove();
    $(".card-step-one").remove();
    $(".card-step-two").remove();
    $(".card-step-three").remove();
  };

  this.clear_all_messages = function (self_id, other_id) {
    if (self_id == null || other_id == null) {
      self_id = self.state.idSelf();
      other_id = self.state.idOther();
    }

    let promise = Promise.all([
      self.io.clear("S1_" + self_id),
      self.io.clear("S1_" + other_id),
      self.io.clear("S2_" + self_id),
      self.io.clear("S2_" + other_id)
    ]);

    promise.then(console.log.bind(null,
      "Cleared all messages for id pair '" + self_id + "'/'" + other_id + "'."
    ));

    return promise;
  };

  this.check_firebase_status_before_stage = function (stage) {
    let connectedRef = firebase.database().ref(".info/connected");
    connectedRef.on("value", function (snap) {
      if (!snap.val() === true) {
        self.modal.showCard(
            "error",
            "Firebase Inaccessible",
            "Cannot reach Firebase service."
        )
      } else {
        self.stages(stage);
      }
    });
  }
}


/*
 * Component with methods for common operations involving
 * button user interface components.
 */
function Buttons(app) {

  /* Dependencies. */

  var require = function (m) { if (!(m in window)) throw new Error('cannot load ' + m); };

  // External.
  require('jQuery');

  /* Internal object attributes. */

  this.app = app; // Reference to overall application object.

  /* Methods. */

  var self = this; // Self-reference for use in method implementations.

  this.enable = function (query) {
    $(query).prop("disabled", false);
    $(query).removeClass("button-disabled");
  }

  this.disable = function (query) {
    $(query).prop("disabled", true);
    $(query).addClass("button-disabled");
  }

  this.label = function (query, text) {
    $(query).prop("value", text);
  }
}


/*
 * Component with methods for common operations involving
 * content card user interface components.
 */
function Cards(app) {

  /* Dependencies. */

  var require = function (m) { if (!(m in window)) throw new Error('cannot load ' + m); };

  // External.
  require('jQuery');

  /* Internal object attributes. */

  this.app = app; // Reference to overall application object.

  /* Methods. */

  var self = this;

  this.introduce = function (queries) {
    for (var i = 0; i < queries.length; i++) {
      $(queries[i]).fadeIn();
      $(queries[i]).css("display", "flex");
    }
  }

  this.activate = function (query) {
    $(query).css("opacity", 1);
  }

  this.complete = function (queryCard, queryButton) {
    // Set card properties to reflect that task is
    // complete.
    $(queryCard).removeClass("card-step-warning");
    $(queryCard).addClass("card-step-complete");
    $(queryCard + "-warning").css("display", "none");
    $(queryCard + "-checkmark").css("display", "inline");

    // If a button to disable is specified, disable it.
    if (queryButton != null) {
      self.app.buttons.disable(queryButton);
    }
  }

  this.completeAndRemain = function (queryCard, queryButton) {
    // Set card properties to reflect that task is
    // complete, but do not fade it out (e.g., in
    // case it is the last step).
    self.complete(queryCard, queryButton);
    $(queryCard).css({"cssText": "opacity: 1 !important; display: flex;"});
  }

  this.warning = function (query) {
    $(query).addClass("card-step-warning");
    $(query + "-warning").css("display", "inline");
  }

  this.subtitle = function (query, html) {
    $(query).find(".card-header-subtitle").html(html);
  }

  this.message = function (query, html) {
    $(query).find(".card-body-message-content").html(html);
  }
}


/**
  * API for interacting with back-end database (i.e., Firebase).
  */
function Channel(app, collectionName, pollInterval, maxBatchSize, msgBandwidth) {

  /* Dependencies. */

  var require = function (m) { if (!(m in window)) throw new Error('cannot load ' + m); };

  // External.
  require('firebase');

  /* Internal attributes. */

  this.app = app;
  this.collectionName = collectionName;
  pollInterval = pollInterval > 0 ? pollInterval : 0;
  maxBatchSize = maxBatchSize > 0 ? maxBatchSize : Infinity;
  msgBandwidth = msgBandwidth > 9 ? msgBandwidth : Infinity;
  this.debug = { log: () => {} /* console.log */ }; // Show debug log for IO messages, etc.

  /* Methods. */

  var self = this; // Self-reference for use in method implementations.

  async function give(data) {
    let tag = data.tag;
    let msg = data.msg;
    let no_batching = data.no_batching;
    let update_progress = data.update_progress;
    let promise = null;

    if (JSON.stringify(msg).length > msgBandwidth && !no_batching) {
      self.debug.log("Message length exceeds " + msgBandwidth + " bytes for \"" + tag + "\".  Batching...");
      let msg_buffer = JSON.stringify(msg).match(new RegExp('.{1,' + msgBandwidth + '}', 'g'));
      let arg = {
        tag: tag,
        msgs: msg_buffer
      }

      if (update_progress) {
        promise = await give_many_progress(arg);
      } else {
        promise = await give_many(arg);
      }
    } else {
      if (update_progress) {
        let arg = {
          tag: tag,
          msg: msg,
          no_batching: true,
          update_progress: false
        }
        promise = await self.app.mapAsyncWithProgress(give, [arg])
      } else {
        self.debug.log("give", tag, msg);
        promise = self.app.collection.push().set({tag, msg});
      }
    }

    return promise;
  }

  async function give_many_progress(data) {
    let tag = data.tag;
    let msgs = data.msgs;
    let n = msgs.length;

    let init = {
      tag: tag,
      msg: {_metadata: {fn: "give_many", size: n}},
      no_batching: true,
      update_progress: false
    }
    let all_msgs = [init];
    for (let i = 0; i < n; i++) {
      all_msgs.push({
        tag: tag + ".part" + (i+1) + ".." + n,
        msg: msgs[i],
        no_batching: true,
        update_progress: false
      })
    }

    return await self.app.mapAsyncWithProgress(give, all_msgs);
  }

  async function give_many(data) {
    let tag = data.tag;
    let msgs = data.msgs;
    let n = msgs.length;
    let init = give({
      tag: tag,
      msg: {_metadata: {fn: "give_many", size: n}},
      no_batching: false
    })

    let promises = [init];
    for (var i = 0; i < n; i++) {
      self.debug.log("give_many", (i+1), "/", n);
      promises.push(
              give({
                tag: tag + ".part" + (i+1) + ".." + n,
                msg: msgs[i],
                no_batching: true
              })
      )
    }

    return Promise.all(promises);
  }

  function peek(tag) {
    return new Promise(function (resolve) {
      let node = self.app.collection.orderByChild("tag").equalTo(tag);
      node.once("value").then(function (response) {
        let msgs = response.val();
        if (msgs != null) {
          resolve(true);
        } else {
          resolve(false);
        }
      });
    });
  }

  function attempt(tag) {
    return new Promise(function (resolve) {
      let node = self.app.collection.orderByChild("tag").equalTo(tag);
      node.once("value").then(function (response) {
        let msgs = response.val();
        if (msgs != null) {
          let keys = Object.keys(msgs);
          let last_key = keys[keys.length - 1];
          let last_msg = msgs[last_key];
          firebase.database().ref(self.collectionName + "/" + last_key).remove();
          resolve(last_msg.msg);
        } else {
          resolve(false);
        }
      });
    });
  }

  async function get_size(data) {
    let tag = data.tag;
    self.debug.log("get_size", tag);

    return new Promise(function (resolve) {
      let node = self.app.collection.orderByChild("tag").equalTo(tag);
      node.once("value").then(async function (response) {
        let msgs = response.val();
        if (msgs != null) {
          let keys = Object.keys(msgs);
          let last_key_idx = keys.length - 1;
          let last_key = keys[last_key_idx];
          let last_msg = msgs[last_key];
          let msg = last_msg.msg;
          if (typeof(msg) === "object" && msg._metadata != null && msg._metadata.fn === "give_many") {
            resolve(msg._metadata.size);
          } else {
            self.debug.log("got", tag, msg);
            resolve(1);
          }
        } else {
          setTimeout(async function () {
            await get_size({tag: tag}).then(resolve);
          }, pollInterval);
        }
      });
    });
  }

  async function get(data) {
    let tag = data.tag;
    let update_progress = data.update_progress;
    self.debug.log("get", tag);

    return new Promise(function (resolve) {
      let node = self.app.collection.orderByChild("tag").equalTo(tag);
      node.once("value").then(async function (response) {
        let msgs = response.val();
        if (msgs != null) {
          let keys = Object.keys(msgs);
          let last_key_idx = keys.length - 1;
          let last_key = keys[last_key_idx];
          let last_msg = msgs[last_key];

          firebase.database().ref(self.app.config.collection + "/" + last_key).remove();

          let msg = last_msg.msg;
          if (typeof(msg) === "object" && msg._metadata != null && msg._metadata.fn === "give_many") {
            if (update_progress) {
              await get_many_progress({tag: tag, n: msg._metadata.size}).then(resolve);
            } else {
              await get_many({tag: tag, n: msg._metadata.size}).then(resolve);
            }
          } else {
            self.debug.log("got", tag, msg);
            resolve(msg);
          }
        } else {
          setTimeout(async function () {
            await get({tag: tag, update_progress: update_progress}).then(resolve);
          }, pollInterval);
        }
      });
    });
  }

  async function get_many_progress(data) {
    let tag = data.tag;
    let n = data.n;
    let queries = [];

    for (let i = 1; i <= n; i++) {
      queries.push({
        tag: tag + ".part" + i + ".." + n,
        update_progress: false
      });
    }

    let promises = await self.app.mapAsyncWithProgress(get, queries);
    let promise = Promise.all(promises);
    return new Promise(function (resolve) {
      promise.then(function (msg_buffer) {
        let long_msg = JSON.parse(msg_buffer.join(""));
        resolve(long_msg);
      });
    });
  }

  async function get_many(data) {
    let tag = data.tag;
    let n = data.n;

    let promises = [];
    for (var i = 1; i <= n; i++) {
      self.debug.log("get_many", i, "/", n);
      promises.push(
        await get({tag: tag + ".part" + i + ".." + n})
      );
    }

    let promise = Promise.all(promises);
    return new Promise(function (resolve) {
      promise.then(function (msg_buffer) {
        let long_msg = JSON.parse(msg_buffer.join(""));
        self.debug.log("got (from batch)", tag, long_msg);
        resolve(long_msg);
      });
    });
  }

  function get_all(tag, __pollInterval, max_count) {
    max_count = max_count > 0 ? max_count : maxBatchSize;
    return new Promise(function (resolve) {
      let node = self.app.collection.orderByChild("tag").equalTo(tag);
      node.once("value").then(function (response) {
        let msgs_obj = response.val();
        if (msgs_obj != null) {
          let keys_array = Object.keys(msgs_obj);
          let msgs_array = keys_array.map(function (key, i) {
            if (i < max_count) {
              let msg = msgs_obj[key];
              firebase.database().ref(self.app.config.collection + "/" + key).remove();
              return msg;
            }
          }).slice(0, max_count);

          resolve(msgs_array);
        } else {
          const do_get = function () { get_all(tag, __pollInterval).then(resolve); };
          setTimeout(do_get, __pollInterval);
        }
      });
    });
  }

  function clear(tag) {
    self.debug.log("clear", tag);
    return new Promise(function (resolve) {
      let node = self.app.collection.orderByChild("tag").equalTo(tag);
      node.once("value").then(function (response) {
        let msgs = response.val();
        if (msgs != null) {
          firebase.database().ref(self.app.config.collection + "/" + Object.keys(msgs)[0]).remove();

          resolve(clear(tag));
        } else {
          resolve(true);
        }
      });
    });
  }

  /* Publicly accessible methods. */
  var exports_ = {};
  exports_.peek = peek;
  exports_.attempt = attempt;
  exports_.get = get;
  exports_.get_size = get_size;
  exports_.get_all = get_all;
  exports_.give = give;
  exports_.clear = clear;
  return exports_;
};


/*
 * Component for building a CSV in-memory and allowing a user to
 * download it by clicking a link.
 */
function CSV(app) {

  /* Internal object attributes. */

  this.app = app; // Reference to overall application object.

  /* Methods. */

  var self = this; // Self-reference for use in method implementations.

  this.__rowToStr = function (row) {
    var rowStr = '';
    for (var j = 0; j < row.length; j++) {
        var value = row[j] === null ? '' : row[j].toString();
        if (row[j] instanceof Date) {
            value = row[j].toLocaleString();
        };
        var current = value.replace(/"/g, '""');
        if (current.search(/("|,|\n)/g) >= 0)
            current = '"' + current + '"';
        if (j > 0)
            rowStr += ',';
        rowStr += current;
    }
    return rowStr + '\n';
  };

  this.download = function () {
    var dataStr = '';
    for (var i = 0; i < self.__data.length; i++) {
      dataStr += self.__rowToStr(self.__data[i]);
    }

    var blob = new Blob([dataStr], {"type": "text/csv;charset=utf-8;"});
    var link = document.createElement("a");
    if (link.download !== undefined) { // Feature detection.
      // Include the date and time in the file name.
      var date = new Date();
      var date_str =
        date.getFullYear() +
        String(date.getMonth() + 1).padStart(2, '0') +
        String(date.getDate()).padStart(2, '0');
      var time_str =
        String(date.getHours()).padStart(2, '0') +
        String(date.getMinutes()).padStart(2, '0') +
        String(date.getSeconds()).padStart(2, '0');
      var filename = 'nth-link-' + date_str + '-' + time_str + '.csv';

      // Browsers that support HTML5 download attribute.
      var url = URL.createObjectURL(blob);
      link.setAttribute("href", url);
      link.setAttribute("download", filename);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
  }
}


/*
 * Component for managing the user-specified data workflow operations,
 * including management of user interface components.
 */
function Data(app) {

  /* Dependencies. */

  var require = function (m) { if (!(m in window)) throw new Error('cannot load ' + m); };

  // External.
  require('jQuery');

  /* Internal object attributes. */

  this.app = app; // Reference to overall application object.
  this.__columnCount = null;
  this.__rowFirstExclude = null;
  this.__columnDomain = null;
  this.__columnJoin = null;
  this.__columnGroupBy = null;

  /* Methods. */

  var self = this; // Self-reference for use in method implementations.

  this.setColumnCount = function (value) {
    self.__columnCount = value;
  }

  this.columnDomain = function () {
    return self.__columnDomain;
  }

  this.rowFirstExclude = function () {
    return self.__rowFirstExclude;
  }

  this.columnJoin = function () {
    return self.__columnJoin;
  }

  this.columnGroupBy = function () {
    return self.__columnGroupBy;
  }

  this.clickFirstRowData = function () {
    $(".first-row-checkbox-data").prop("checked", true);
    $(".first-row-checkbox-header").prop("checked", false);
    self.__rowFirstExclude = false;
    $(".data_row_first_cell").removeClass("data_row_first_cell_excluded");
  };

  this.clickFirstRowHeader = function () {
    $(".first-row-checkbox-data").prop("checked", false);
    $(".first-row-checkbox-header").prop("checked", true);
    self.__rowFirstExclude = true;
    $(".data_row_first_cell").addClass("data_row_first_cell_excluded");
  };

  this.toggleIndependentCell = function (op, column) {
    var id = "#data_" + op + "_checkbox_" + column;
    $(id).prop("checked", !$(id).is(':checked'));
    self.toggleIndependent(op, column, false);
  }

  this.toggleIndependent = function (op, column, direct) {
    var id = "#data_" + op + "_checkbox_" + column;

    // Ignore a direct click to avoid conflict with cell click.
    if (direct) {
      $(id).prop("checked", !$(id).is(':checked'));
    }

    if ($(id).is(':checked')) {
      // Update internal state.
      if (op == 'domain') {
        this.__columnDomain = column;
      }

      // Uncheck all other checkboxes for the same operator (i.e., in same row).
      for (var c = 0; c < self.__columnCount; c++) {
        if (c != column) {
          $("#data_" + op + "_checkbox_" + c).prop("checked", false);
          $(".data_" + op + "_checkbox_" + c + "_cell").removeClass("data_op_" + op);
        }
      }

      // Add the highlight for the operation being toggled.
      $(".data_" + op + "_checkbox_" + column + "_cell").addClass("data_op_" + op);
    } else {
      // Indicate the disabled operation in the state.
      if (op == 'domain') {
        this.__columnDomain = null;
        $(".data_" + op + "_checkbox_" + column + "_cell").removeClass("data_op_" + op);
      }
    }
  }

  this.toggleCell = function (op, column) {
    var id = "#data_" + op + "_checkbox_" + column;
    $(id).prop("checked", !$(id).is(':checked'));
    self.toggle(op, column, false);
  }

  this.toggle = function (op, column, direct) {
    var id = "#data_" + op + "_checkbox_" + column;

    // Ignore a direct click to avoid conflict with cell click.
    if (direct) {
      $(id).prop("checked", !$(id).is(':checked'));
    }

    if ($(id).is(':checked')) {
      // Update internal state.
      if (op == 'join') {
        this.__columnJoin = column;
        this.__columnGroupBy = (this.__columnGroupBy == column) ? null : this.__columnGroupBy;
      } else if (op == 'groupby') {
        this.__columnJoin = (this.__columnJoin == column) ? null : this.__columnJoin;
        this.__columnGroupBy = column;
      }

      // Uncheck all other checkboxes in the same column that are not
      // independent.
      $(".data_checkbox_" + column).not(id).not(".data_independent_checkbox").prop("checked", false);

      // Uncheck all other checkboxes for the same operator (i.e., in same row).
      for (var c = 0; c < self.__columnCount; c++) {
        if (c != column) {
          $("#data_" + op + "_checkbox_" + c).prop("checked", false);
          $(".data_column_" + c).removeClass("data_op_" + op);
          $(".data_" + op + "_checkbox_" + c + "_cell").removeClass("data_op_" + op);
        }
      }

      // Clear existing highlights for non-independent operators in the
      // selected column.
      $(".data_column_" + column).removeClass("data_op_join");
      $(".data_column_" + column).removeClass("data_op_groupby");
      $(".data_join_checkbox_" + column + "_cell").removeClass("data_op_join");
      $(".data_groupby_checkbox_" + column + "_cell").removeClass("data_op_groupby");

      // Add the highlight for the operation being toggled.
      $(".data_" + op + "_checkbox_" + column + "_cell").addClass("data_op_" + op);
      $(".data_column_" + column).addClass("data_op_" + op);
    } else {
      // Indicate the disabled operation in the state.
      if (op == 'join') {
        this.__columnJoin = null;
      } else if (op == 'groupby') {
        this.__columnGroupBy = null;
      }

      // Remove highlights.
      $(".data_join_checkbox_" + column + "_cell").removeClass("data_op_" + op);
      $(".data_groupby_checkbox_" + column + "_cell").removeClass("data_op_" + op);
      $(".data_column_" + column).removeClass("data_op_" + op);
    }
  }
}


/*
 * Component for creating and validating party identifiers.
 */
function IDs(app) {

  /* Internal object attributes. */

  this.app = app; // Reference to overall application object.

  /* Methods. */

  var self = this; // Self-reference for use in method implementations.

  this.idLength = function () {
    return 9;
  };

  this.idCreateRecipient = function (recipientOrContributor) {
    var identifier = 'r', cs = 'ABCDEFRXYZabcdefrxyz23456789';
    for (var i = 0; i < 8; i++) {
      identifier += cs.charAt(Math.floor(Math.random() * cs.length));
    }
    return identifier;
  };

  this.idCreateContributor = function (recipientOrContributor) {
    var identifier = 'c', cs = 'ABCDEFRXYZabcdefrxyz23456789';
    for (var i = 0; i < 8; i++) {
      identifier += cs.charAt(Math.floor(Math.random() * cs.length));
    }
    return identifier;
  };

  this.idCreateStandard = function () {
    return "xxxyxx".replace(/[xy]/g, function (c) {
      var r = Math.random() * 16 | 0, v = c == "x" ? r : (r & 0x3 | 0x8);
      return v.toString(16);
    });
  };
}


/*
 * Component with methods for managing the modal.
 */
function Modal(app) {

  /* Dependencies. */

  var require = function (m) { if (!(m in window)) throw new Error('cannot load ' + m); };

  // External.
  require('jQuery');

  /* Internal object attributes. */

  this.app = app; // Reference to overall application object.
  this.__shown = false;

  /* Methods. */

  var self = this; // Self-reference for use in method implementations.

  this.showCard = function (title, subtitle, content) {
    self.__shown = true;

    $(".progress").css("display", "none");
    $("#progress-message").css("display", "none");
    $(".modal").find(".card-header-title").html(title);
    $(".modal").find(".card-header-subtitle").html(subtitle);
    $(".modal").find(".card-body-message-content").html(content);
    $(".modal-card-deck").css("display", "flex");
    $(".modal").modal("show");
  }

  this.showPrivacyPolicy = function () {
    self.__shown = true;

    self.showCard(
      "Terms and Policies",
      "Privacy Policy",
      '<iframe id="iframe-terms-and-policies" src="legal-privacy-policy.html"></iframe>'
    );
    self.app.iframeResize();
  }

  this.showTermsOfService = function () {
    self.__shown = true;

    self.showCard(
      "Terms and Policies",
      "Terms and Conditions of Use",
      '<iframe id="iframe-terms-and-policies" src="legal-terms-of-service.html"></iframe>'
    );
    self.app.iframeResize();
  }

  this.showProgress = function (content, percent) {
    self.__shown = true;

    $(".modal-card-deck").css("display", "none");
    self.app.progress.setPercent(percent);
    self.app.progress.message(content);
    $(".progress").css("display", "flex");
    $("#progress-message").css("display", "block");
    $(".modal").modal("show");
  }

  this.hide = function () {
    self.__shown = false;

    $(".modal").modal("hide");
    setTimeout(function () {
      if ($(".modal").hasClass("show")) {
        self.hide();
      } else {
        self.app.progress.reset();
      }
    }, 250);
  }
}


/*
 * Encapsulated component for managing a progress bar user
 * interface component (and associated HTML content containers).
 */
function Progress(length) {

  /* Dependencies. */

  var require = function (m) { if (!(m in window)) throw new Error('cannot load ' + m); };

  // External.
  require('jQuery');

  /* Internal object attributes. */

  this.length = length;
  this.index = 0;

  /* Methods. */

  var self = this; // Self-reference for use in method implementations.

  this.setPercent = function (percent) {
    $("#progress-overall-bar").css("width", percent+"%").attr("aria-valuenow", percent);
  };

  this.setLength = function (length) {
    self.length = length;
    self.index = 0;
    self.setPercent(0);
  };

  this.reduceLengthBy = function (length) {
    self.length -= length;
    self.setPercent(Math.floor((100 * self.index) / self.length));
  };

  this.advanceByLength = function (delta) {
    delta =  (delta == null) ? 1 : delta;
    self.index += delta;
    self.setPercent(Math.floor((100 * self.index) / self.length));
  };

  this.advanceByPercent = function (delta) {
    delta =  (delta == null) ? 1 : delta;
    self.index += (delta * self.length) / 100;
    percent = Math.floor((100 * self.index) / self.length);
    self.setPercent(Math.floor((100 * self.index) / self.length));
  };

  this.message = function (text) {
    $("#progress-message").text(text);
  }

  this.reset = function () {
    self.message("");
    self.setPercent(0);
  }
}


/*
 * Encoding/decoding and cryptographic primitives for protocol.
 */
function Protocol(app, state) {

  /* Dependencies. */

  var require = function (m) { if (!(m in window)) throw new Error('cannot load ' + m); };

  // External.
  require('sodium');

  /* Internal object attributes. */

  this.app = app;

  this.encode_small = function (v) { return sodium.to_base64(v, 1); };
  this.decode_small = function (v) { return sodium.from_base64(v, 1); };
  this.encode_fast = sodium.to_hex;
  this.decode_fast = sodium.from_hex;

  this._key =
    (state.protocolKey() != null) ?
    state.protocolKey() :
    sodium.crypto_core_ristretto255_scalar_random();
  this._mask =
    (state.protocolMask() != null) ?
    state.protocolMask() :
    sodium.crypto_core_ristretto255_scalar_random();
  this._maskInv =
    sodium.crypto_core_ristretto255_scalar_invert(this._mask);

  /* Methods. */

  var self = this; // Self-reference for use in method implementations.

  this.encode = function (point) {
    return self.encode_small(point);  // btoa(String.fromCharCode.apply(null, point));
  };

  this.decode = function (str) {
    return self.decode_small(str);  // new Uint8Array(atob(str).split("").map(function (c) { return c.charCodeAt(0); }));
  };

  this.encode_debug = function (point) {
    return point.join(",");
  };

  this.decode_debug = function (str) {
    return new Uint8Array(e.split(",").map(function (s) { return parseInt(s); }));
  };

  this.strToPoint = function (s) {
    // Hash to a point.
    var h = sodium.to_hex(sodium.crypto_generichash(64, sodium.from_string(s)));
    return sodium.crypto_core_ristretto255_from_hash(h);
  };

  this.key = function (point) {
    return sodium.crypto_scalarmult_ristretto255(self._key, point);
  };

  this.keyEncode = function (point) {
    return self.encode(self.key(point));
  };

  this.decodeKeyEncode = function (encodedPoint) {
    return self.encode(self.key(self.decode(encodedPoint)));
  };

  this.decodeMaskEncode = function (encodedPoint) {
    return self.encode(self.mask(self.decode(encodedPoint)));
  };
  this.mask = function (point) {
    return sodium.crypto_scalarmult_ristretto255(self._mask, point);
  };

  this.maskEncode = function (point) {
    return self.encode(self.mask(point));
  };

  this.unmask = function (point) {
    return sodium.crypto_scalarmult_ristretto255(self._maskInv, point);
  };

  this.decodeUnmask = function (encodedPoint) {
    return self.unmask(self.decode(encodedPoint));
  };

  this.pointToReducedStr = function (point) {
    return self.encode_fast(point);
  };

  this.shuffle = function shuffle(arr) {
    var k, i;
    for (k = arr.length; k > 0; k--) {
      i = sodium.randombytes_uniform(k);
      [arr[i], arr[k-1]] = [arr[k-1], arr[i]];
    }
    return arr;
  };

  this.deduplicateStrs = function (ss) {
    var dss = [];
    for (var i = 0; i < ss.length; i++) {
      if (dss.indexOf(ss[i]) == -1) {
        dss.push(ss[i]);
      }
    }
    return dss;
  };

  this.arrayOfStrToStr = function (a) {
    // Apply the various column operations if they are enabled.
    var columnDomain = self.app.data.columnDomain();
    if (columnDomain != null) {
      a[columnDomain] =
        (
          a[columnDomain].replace(/https?:\/\//, "").replace(/^(www\.)?/, "") + "/"
        ).split("/")[0].trim();
    }
    var columnJoin = self.app.data.columnJoin();
    var v = (columnJoin == null) ? a.join("") : a[columnJoin];

    return v;
  };

  this.arrayOfStrToPoint = function (a) {
    // Apply the various column operations if they are enabled.
    var columnDomain = self.app.data.columnDomain();
    if (columnDomain != null) {
      a[columnDomain] =
        (
          a[columnDomain].replace(/https?:\/\//, "").replace(/^(www\.)?/, "") + "/"
        ).split("/")[0].trim();
    }
    var columnJoin = self.app.data.columnJoin();
    var v = (columnJoin == null) ? a.join("") : a[columnJoin];
    return self.strToPoint(v);
  };
}


/*
 * Encapsulated session state (for an individual session) and methods
 * to create payloads for each step in a session.
 */
function Session(app, state, selfRoles) {

  /* Dependencies. */

  var require = function (m) { if (!(m in window)) throw new Error('cannot load ' + m); };

  // Internal.
  require('Protocol');

  /* Internal object attributes. */

  this.app = app;
  this.state = state;
  this.roles = selfRoles;
  this.id = state.idSelf();
  this.other = { // State of other contributor.
    "id": state.idOther(),
    "data": {},
    "roles": []
  }
  this.protocol = new Protocol(app, state);
  this.data = {};

  /* Methods. */

  var self = this; // Self-reference for use in method implementations.

  this.prepareSelfData = async function (data) {
    // Turn rows into strings, deduplicate them, and hash them to points.
    let arrayOfStrs = data.map(self.protocol.arrayOfStrToStr);

    // Exclude first row if it is designated as a header row by the user.
    if (self.app.data.rowFirstExclude()) {
      arrayOfStrs.shift();
    }

    let ss = self.protocol.deduplicateStrs(arrayOfStrs);
    let points = await self.app.mapAsyncWithProgress(self.protocol.strToPoint, ss);

    self.data = {
      "clear": data,
      "points": points
    };

    return true;
  };

  this.stepZero = async function () {
    var stepResult = {
      "roles": self.roles,
      "data": {
        "keyed": {},
        "masked": {}
      }
    };

    // Update the progress bar modal message.
    self.app.progress.message("Encrypting data for analysis.");

    // If we are not the recipient, prepare own keyed data for transmission.
    if (!self.roles.includes("recipient")) {
      // Encrypt the data using own key.
      stepResult.data.keyed = await self.app.mapAsyncWithProgress(self.protocol.keyEncode, self.data.points);

      // Display the encrypted data for the user.
      self.app.sheets.self.data(stepResult.data.keyed, true);
    }

    // If we are the recipient, prepare own masked data for transmission.
    if (self.roles.includes("recipient")) {
      // Encrypt the data using own mask.
      self.data.masked = await self.app.mapAsyncWithProgress(self.protocol.maskEncode, self.data.points);
      stepResult.data.masked = self.data.masked;

      // Display the encrypted data for the user.
      self.app.sheets.self.data(stepResult.data.masked, true);
    }

    return stepResult;
  };

  this.stepOne = async function (message) {
    var stepResult = { "data": { "masked": { "keyed": {} } } };

    const key = sodium.crypto_core_ristretto255_from_hash(sodium.crypto_generichash(64, sodium.from_string("0")));

    // If we are the recipient, retrieve other contributor's keyed data.
    if (self.roles.includes("recipient")) {
      self.other.data.keyed_by_other = await self.app.mapAsyncWithProgress(self.protocol.decode, message.data.keyed);
    }

    // If other party is a recipient, key their masked data and return it.
    self.other.roles = message.roles;
    if (self.other.roles.includes("recipient")) {
      let data = await self.app.mapAsyncWithProgress(self.protocol.decodeKeyEncode, message.data.masked);

      // Do not shuffle keyed data before contributing.
      stepResult.data.masked.keyed = data;

      const response_ = await self.services({"associates_public_key": []});
      const keyPublic = sodium.from_base64(response_['associates_public_key'][0], 1);
      stepResult.data.keyEncrypted = sodium.to_base64(sodium.crypto_box_seal(self.protocol._key, keyPublic), 1);

      const keysMask = sodium.crypto_core_ristretto255_scalar_random();
      const keysMaskEncrypted = sodium.crypto_box_seal(keysMask, keyPublic);
      stepResult.data.keysMaskEncrypted = sodium.to_base64(keysMaskEncrypted, 1);

      var keys = [];
      stepResult.data.keys = await self.app.mapAsyncWithProgress(function (rowPlain) {
        const key = sodium.crypto_core_ristretto255_from_hash(
          sodium.crypto_generichash(64, sodium.randombytes_buf(32))
        );
        keys.push(key);
        const keyMasked = sodium.crypto_scalarmult_ristretto255(keysMask, key);
        return sodium.to_base64(keyMasked, 1);
      }, self.data.clear);

      const columnJoin = self.app.data.columnJoin();
      stepResult.data.enriching = await self.app.mapAsyncWithProgress(function (rowPlain, i) {
        var row = [];
        for (var j = 0; j < rowPlain.length; j++)  {
          if (j != columnJoin) {
            const bytes = sodium.from_string(rowPlain[j]);
            const nonce = sodium.randombytes_buf(sodium.crypto_secretbox_NONCEBYTES);
            const cipher_ = sodium.crypto_secretbox_easy(bytes, nonce, keys[i]);
            const cipher = new Uint8Array(nonce.length + cipher_.length);
            cipher.set(nonce);
            cipher.set(cipher_, nonce.length);              
            row.push(sodium.to_base64(cipher, 1));
          }
        }
        return row;
      }, self.data.clear);
    }

    return stepResult;
  };

  this.stepTwo = async function (message) {
    var stepResult = { "other": { "roles": self.other.roles } };

    // If we are a recipient, obtain the data and compute the result.
    if (
      self.roles.includes("recipient")
      && message.data != null
      && message.data.masked.keyed != null
    ) {
      self.app.progress.message("Operating on the encrypted data.");

      // We have the message and it contains the data we expect.
      // Unmask own masked data that has been keyed by other contributor.
      self.data.keyed_by_other = await self.app.mapAsyncWithProgress(self.protocol.decodeUnmask, message.data.masked.keyed);

      // Keep only bytes that will intersect.
      self.other.data.keyed_by_other_ = await self.app.mapAsyncWithProgress(self.protocol.pointToReducedStr, self.other.data.keyed_by_other);
      self.data.keyed_by_other = await self.app.mapAsyncWithProgress(self.protocol.pointToReducedStr, self.data.keyed_by_other);

      // Intersect `self.other.data.keyed_by_other` and `self.data.keyed_by_other`.
      self.app.progress.message("Computing the analysis results.");

      // Mask keyed data from other contributor and package it up with own masked data
      // so that nth.services can decode compare both and return appropriate keys.
      const servicesRequest = {
        "keyEncrypted": message.data.keyEncrypted,
        "otherKeyedMasked": await self.app.mapAsyncWithProgress(self.protocol.maskEncode, self.other.data.keyed_by_other),
        "selfMasked": self.data.masked,
        "otherKeysMasked": message.data.keys,
        "otherKeysMaskEncrypted": message.data.keysMaskEncrypted
      };

      // The nth.services API (or a simulation thereof) returns unmasked 
      // keys for common rows (with all other keys remaining masked).
      const response_ = await self.services(
        {"associates_intersect_unmask_keys": servicesRequest}
      );
      const otherKeysUnmasked = await self.app.mapAsyncWithProgress(function (key) {
        return sodium.from_base64(key, 1);
      }, response_.keys);

      // Add the entry to the intersection if appropriate to do so.
      stepResult.count = 0;
      stepResult.intersection = await self.app.mapAsyncWithProgress(function (row, i) {
        const item = self.data.keyed_by_other[i];
        const j = self.other.data.keyed_by_other_.indexOf(item);
        if (j != -1) {
          stepResult.count += 1;
          const row_enriching = message.data.enriching[j];
          for (var k = 0; k < row_enriching.length; k++)  {
            try {
              const key = otherKeysUnmasked[j];
              const nonceCipher = sodium.from_base64(row_enriching[k], 1);
              const nonce = nonceCipher.slice(0, 24);
              const cipher = nonceCipher.slice(24);
              row.push(sodium.to_string(sodium.crypto_secretbox_open_easy(cipher, nonce, key)));
            }  catch (err) {
              console.log(err);
              row.push("");
            }
          }
        }
        return row;
      }, self.data.clear);
    }

    return stepResult;
  };

  this.services = async function (servicesRequest) {
    if ("services" in self.app.config) {
      const response_ = await fetch(
        self.app.config.services.url,
        {
          method: 'POST',
          headers: {"Content-type": "application/json", "x-api-key": self.app.config.services.key},
          body: JSON.stringify(servicesRequest)
        }
      );
      const response = await response_.json();
      console.log(response);
      return response;
    } else {
      const keySecret = new Uint8Array([1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]);
      const keyPublic = sodium.crypto_scalarmult_base(keySecret);
      if ("associates_public_key" in servicesRequest) {         
        return {"associates_public_key": [sodium.to_base64(keyPublic, 1)]};
      } else if ("associates_intersect_unmask_keys" in servicesRequest) {
        const req = servicesRequest["associates_intersect_unmask_keys"];

        const keysUnmask = sodium.crypto_core_ristretto255_scalar_invert(
          sodium.crypto_box_seal_open(
            sodium.from_base64(req.otherKeysMaskEncrypted, 1),
            keyPublic, keySecret
          )
        );
        const unkey = sodium.crypto_core_ristretto255_scalar_invert(
          sodium.crypto_box_seal_open(
            sodium.from_base64(req.keyEncrypted, 1),
            keyPublic, keySecret
          )
        );
        const otherUnkeyed = await self.app.mapAsyncWithProgress(function (keyedMasked) {
          return sodium.to_base64(sodium.crypto_scalarmult_ristretto255(unkey, sodium.from_base64(keyedMasked, 1)), 1);
        }, req.otherKeyedMasked);
        const otherKeysUnmasked = await self.app.mapAsyncWithProgress(function (key, i) {
          if (req.selfMasked.indexOf(otherUnkeyed[i]) != -1) {
            return sodium.to_base64(sodium.crypto_scalarmult_ristretto255(keysUnmask, sodium.from_base64(key, 1)), 1);
          } else {
            return key;
          }
        }, req.otherKeysMasked);

        return {"keys": otherKeysUnmasked};
      }
    }
  };
}


/*
 * Internal state and methods for spreadsheet-like user interface
 * component instances.
 */
function Sheet(app, elementId, data) {

  /* Dependencies. */

  var require = function (m) { if (!(m in window)) throw new Error('cannot load ' + m); };

  // External.
  require('jQuery');

  /* Internal object attributes. */

  this.app = app;
  this.data = data;
  this.elementId = elementId;

  /* Methods. */

  var self = this; // Self-reference for use in method implementations.

  this.settings = function (data) {
    return {};
  };

  this.table_operation_independent_row = function (table_element, column_count, op, op_html) {
    var tr = document.createElement("tr");
    var td_row = document.createElement("td");
    td_row.innerHTML = op_html;
    td_row.classList.add("row-operation");
    tr.appendChild(td_row);
    for (var c = 0; c < column_count; c++) {
      var td = document.createElement("td");
      var toggle = "app.data.toggleIndependent('" + op + "', " + c + ", true);";
      td.classList.add("data_" + op + "_checkbox_" + c + "_cell");
      td.classList.add("data_checkbox_cell");
      td.classList.add("data_independent_checkbox_cell");
      td.innerHTML =
        '<input type="checkbox"' +
        ' class="data_independent_checkbox data_checkbox_' + c + '"' +
        ' id="data_' + op + '_checkbox_' + c + '"' +
        ' onclick="' + toggle + '"/>';
      const op_ = ''+op, c_ = parseInt(''+c);
      td.onclick = function () { app.data.toggleIndependentCell(op_, c_); };
      tr.appendChild(td);
    }
    table_element.appendChild(tr);
  };

  this.table_operation_row = function (table_element, column_count, op, op_html, tooltip) {
    var tr = document.createElement("tr");
    var td_row = document.createElement("td");

    if (tooltip == null) {
      td_row.innerHTML = op_html;
    } else {
      td_row.innerHTML =
        '<div data-toggle="tooltip" data-html="true" title="' +
        tooltip +
        '">' + op_html + '</div>'
        ;
    }

    td_row.classList.add("row-operation");
    tr.appendChild(td_row);
    for (var c = 0; c < column_count; c++) {
      var td = document.createElement("td");
      var toggle = "app.data.toggle('" + op + "', " + c + ", true);";
      td.classList.add("data_" + op + "_checkbox_" + c + "_cell");
      td.classList.add("data_checkbox_cell");
      td.innerHTML =
        '<div ' +
        (
          'data-toggle="tooltip" data-html="true"' +
          'title="' + tooltip + '"'
        ) +
        ' style="width:100%; height:100%;">' +
        '<input type="checkbox"' +
        ' class="data_checkbox_' + c + '"' +
        ' id="data_' + op + '_checkbox_' + c + '"' +
        ' onclick="' + toggle + '" ' +
        '/>' +
        '</div>'
        ;
      const op_ = ''+op, c_ = parseInt(''+c);
      td.onclick = function () { app.data.toggleCell(op_, c_); };
      tr.appendChild(td);
    }
    table_element.appendChild(tr);
  };

  this.grouped = function (data) {
      // Share reference to data with CSV module instance.
      self.app.csv.__data = data;

      // Update the card header and analysis results description/save content.
      $("#card-data-header-content").html("View and save your analysis results");
      $("#data-preview-description").html(
        (data.length > 0 ? 'The enriched results are displayed below.' :
                           'The results contain 0 rows.'
        ) +
        (data.length == 0 ? '' : (
          ' <a href="javascript:void(0)" onclick="app.csv.download();">Click here</a>' +
          ' to save these results as a CSV file.'
        ))
      );

      if (self.sheet == null) { // No spreadsheet library; using HTML table.
        // Build preview of at most first 100 rows.
        $("#preview-table").remove();
        var tbl = document.createElement("table");
        tbl.id = "preview-table";
        document.getElementById("preview").appendChild(tbl);

        var column_count = 0;
        if (data.length > 0) {
          column_count = data[0].length;
          self.app.data.setColumnCount(column_count);
        }

        // Add data preview.
        for (var r = 0; r < data.length; r++) {
          var tr = document.createElement("tr");
          var td_row = document.createElement("td");
          td_row.innerHTML = r + 1;
          td_row.classList.add("row-number");
          tr.appendChild(td_row);

          // Display plaintext or encrypted data.
          for (var c = 0; c < data[r].length; c++) {
            var td = document.createElement("td");
            td.classList.add("data_column_" + c);
            td.innerHTML = data[r][c];
            tr.appendChild(td);
          }

          tbl.appendChild(tr);
        }
        $("#preview").show();
    }
  }

  this.data = function (data, encrypted) {
    // Is the data being displayed in encrypted form?
    encrypted = (encrypted == null) ? false : encrypted;

    // Convert encrypted data to one-column format.
    var data_ = [];
    if (encrypted) {
      for (var r = 0; r < data.length; r++) {
        data_.push([data[r]]);
      }
      data = data_;
    }

    if (data == null) {
      return self.__data; // No new data was supplied; return current data.
    } else {
      // Update reference to data.
      self.__data = data;

      // Hide the placeholder message.
      $("#data-preview-description").html(
        (self.__data.length <= 100)
        ?
        (
          "Shown below are the <b>" + self.__data.length + " " +
          (encrypted ? "encrypted " : "") +
          "entries</b> of your data contribution."
        )
        :
        (
          (!encrypted) ?
            (
              "Shown below are the <b>first " +
              "100 entries (of " + self.__data.length +
              " entries in total)</b> of your data contribution." +
              //
              "<br/><b>All " + self.__data.length +  " entries</b> " +
              "are deduplicated, encrypted, and included in the analysis."
            )
            :
            (
              "Shown below are the encrypted <b>first " +
              "100 entries (of " + self.__data.length +
              " <i>unique</i> entries in total)</b> of your data contribution." +
              //
              "<br/><b>All " + self.__data.length +  " unique encrypted entries</b> " +
              "are included in the analysis."
            )
        )
      );

      if (self.sheet == null) { // No spreadsheet library; using HTML table.
        // Build preview of at most first 100 rows.
        $("#preview-table").remove();
        var tbl = document.createElement("table");
        tbl.id = "preview-table";
        document.getElementById("preview").appendChild(tbl);

        var column_count = 0;
        if (data.length > 0) {
          column_count = data[0].length;
          self.app.data.setColumnCount(column_count);
        }

        // If this is the non-encrypted data, check the app configuration and
        // show data operation checkboxes that are enabled.
        if (!encrypted) {
          if (self.app.config.operations.domain) {
            self.table_operation_independent_row(tbl, column_count, "domain", "DOMAIN");
          }
          if (self.app.config.operations.join) {
            self.table_operation_row(
              tbl, column_count,
              "join",
              'MATCH USING ONLY<br/>SELECTED COLUMN<br/>(OPTIONAL)',
              (
                "If you select a column, only that column will be used to match a row in your data with a row " +
                "in your partner's data. " +
                "However, your partner will also need to select a compatible column with the same type of data." +
                "<br/><br/>" +
                "If no column is selected, rows on both sides must match exactly " +
                "(in terms of the columns, the order of the columns, and the values in those columns) " +
                "to contribute to the total overlap."
              )
            );
          }
          if (self.app.config.operations.groupBy) {
            if (self.app.state.idSelf()[0] == 'r') { // Only for session creators.
              self.table_operation_row(tbl, column_count, "groupby", "GROUP BY");
            }
          }
        }

        // Add data preview.
        for (var r = 0; r < Math.min(100, data.length); r++) {
          var tr = document.createElement("tr");
          var td_row = document.createElement("td");

          if ( r == 0 && !encrypted &&
               "operations" in self.app.config &&
               "toggleFirstRow" in self.app.config.operations &&
               self.app.config.operations.toggleFirstRow
             ) {
            td_row.innerHTML +=
              '<div class="exclude-first-row-toggle-div" data-toggle="tooltip" data-html="true" title="' +
                "If the first row contains column names, exclude it from the analysis by selecting HEADER." +
              '">' +
                '<table><tr><td>' +
                  '<table><tr><td>' +
                    '<input type="checkbox" id="first-row-checkbox-data"' +
                      ' class="first-row-checkbox-data"' +
                      ' onclick="app.data.clickFirstRowData();"'+
                      ' checked/>' +
                  '</td>' +
                  '<td class="first-row-checkbox-label">'+
                    '<label for="first-row-checkbox-data">DATA</label>' +
                  '</td></tr></table>' +
                '</td>' +
                '<td>' +
                  '<table><tr><td>' +
                    '<input type="checkbox" id="first-row-checkbox-header"' +
                      ' class="first-row-checkbox-header"' +
                      ' onclick="app.data.clickFirstRowHeader();"' +
                      '/>' +
                  '</td>' +
                  '<td class="first-row-checkbox-label">' +
                    '<label for="first-row-checkbox-header">HEADER</label>' +
                  '</td></tr></table>' +
                '</td></tr></table>' +
              '</div>'
              + (r + 1);
          } else {
            td_row.innerHTML = r + 1;
          }

          td_row.classList.add("row-number");
          tr.appendChild(td_row);

          // Display plaintext or encrypted data.
          for (var c = 0; c < data[r].length; c++) {
            var td = document.createElement("td");
            td.classList.add("data_column_" + c);
            td.classList.add("data_cell");
            if (r == 0) {
              td.classList.add("data_row_first_cell");
            }
            td.innerHTML = data[r][c];
            tr.appendChild(td);
          }

          tbl.appendChild(tr);
        }
        $("#preview").show();
      } else { // Using spreadsheet library.
        // Display the spreadsheet HTML container.
        $("#sheet-self").show();

        // Update data with supplied data.
        //self.sheet.updateSettings(self.settings(data));

        // Make all cells read-only.
        /* self.sheet.updateSettings({
          cells: function (row, col) { return {"readOnly": true}; }
        });*/
      }

      // Enable tooltips once element is in the document.
      $('[data-toggle="tooltip"]').tooltip();
    }
  }

  // Create spreadsheet object and populate HTML element.
  data = data == null ? [[""]] : data; // Default data: one cell.
  if (false) { // Toggle spreadsheet library.
    /*self.sheet = new Handsontable(
      document.getElementById(self.elementId),
      self.settings(data)
    );*/
  }
}


/*
 * Encapsulated component for managing multiple spreadsheet-like
 * user interface components.
 */
function Sheets(app) {

  /* Dependencies. */

  var require = function (m) { if (!(m in window)) throw new Error('cannot load ' + m); };

  // External.
  require('jQuery');
  require('_'); // Underscore.js.

  // Internal.
  require('Sheet');

  /* Internal object attributes. */

  this.app = app;

  /* Methods. */

  var self = this; // Self-reference for use in method implementations.

  this.randomDataFraction = function (n) {
    return Math.floor((3 * n) / 5);
  };

  this.selfSelectRandomData = function (value) {
    
    // Use selection unless a parameter was provided.
    value =
      "data-" + (
        self.app.state.resultsReceive() ? "recipient" : "contributor"
      ) + ".json";

    fetch(value)
      .then(response => {
        if (!response.ok) {
          throw new Error("HTTP error " + response.status);
        }
        return response.json();
      })
      .then(data => { // The `data` result is a JSON object.
        self.app.state.dataSelf(data);

        // Show and populate the data preview table.
        self.self.data(data);
      })
      .catch(function () {
        // Should report a connectivity issue.
      });
  };

  this.initialize = function () {
    // Create spreadsheets.
    self.self = new Sheet(self.app, "sheet-self");
  };
}


/*
 * Internal state of an application (including party identifiers, analysis
 * attributes/toggles, persistent protocol credentials and cryptographic
 * material, and other information).
 */
function State(app) {

  /* Dependencies. */

  var require = function (m) { if (!(m in window)) throw new Error('cannot load ' + m); };

  // External.
  require('jQuery');
  require('sodium');

  /* Internal object attributes. */

  // Reference to overall application object.
  this.app = app;

  // Participant identities.
  this.__idSelf = null;
  this.__idOther = null;

  // Protocol options/parameters.
  this.__resultsReceive = true;
  this.__resultsQuantitative = false;

  // Cryptographic configuration.
  this.__protocolKey = sodium.crypto_core_ristretto255_scalar_random();
  this.__protocolMask = sodium.crypto_core_ristretto255_scalar_random();

  // The in-memory copy of the data as an array of arrays.
  this.__dataSelf = null;

  // Other information.
  this.__dataOtherLength = 0; // Initialized to work smoothly in all cases.

  /* Methods. */

  var self = this; // Self-reference for use in method implementations.

  this.idSelf = function (value) {
    if (value == null) {
      return self.__idSelf;
    } else {
      // Update state.
      self.__idSelf = value;
    }
  };

  this.idOther = function (value) {
    if (value == null) {
      return self.__idOther;
    } else {
      // Update state.
      self.__idOther = value;
    }
  };

  this.protocolKey = function (value) {
    if (value == null) {
      return self.__protocolKey;
    } else {
      self.__protocolKey = value;
    }
  };

  this.protocolMask = function (value) {
    if (value == null) {
      return self.__protocolMask;
    } else {
      self.__protocolMask = value;
    }
  };

  this.resultsReceive = function (value) {
    if (value == null) {
      // Synchronize state with UI component (if it exists).
      if ($("#receive").length) {
        self.__resultsReceive = $("#receive").is(":checked");
      }
      // Return state.
      return self.__resultsReceive;
    } else {
      // Synchronize UI component (if it exists) with state.
      if ($("#receive").length) {
        $("#receive").prop("checked", value);
      }
      // Update state.
      self.__resultsReceive = value;
    }
  };

  this.resultsQuantitative = function (value) {
    if (value == null) {
      // Synchronize state with UI component (if it exists).
      if ($("#quantitative").length) {
        self.__resultsQuantitative = $("#quantitative").is(":checked");
      }
      // Return state.
      return self.__resultsQuantitative;
    } else {
      // Synchronize UI component (if it exists) with state.
      if ($("#quantitative").length) {
        $("#quantitative").prop("checked", value);
      }
      // Update state.
      self.__resultsQuantitative = value;
    }
  };

  this.dataSelf = function (value) {
    if (value == null) {
      return self.__dataSelf;
    } else {
      self.__dataSelf = value;

      // Show and populate the data preview table.
      self.app.sheets.self.data(self.__dataSelf);
    }
  };
}


/*
 * Component for reading/writing the URL and parsing and building URLs.
 */
function URLs(app) {

  /* Internal object attributes. */

  this.app = app; // Reference to overall application object.

  /* Methods. */

  var self = this; // Self-reference for use in method implementations.

  this.shuffleParam = function (value) {
    if (value.length == 18 || value.length == 27) {
      var value_shuffled = "";
      for (var i = 0; i < 9; i++) {
        value_shuffled += value[i] + value[9+i] + ((value.length == 27) ? value[18+i] : "");
      }
      return value_shuffled;
    } else {
      return value;
    }
  }

  this.unshuffleParam = function (value) {
    if (value.length == 18 || value.length == 27) {
      const numEntries = Math.floor(value.length/9);
      var value_unshuffled = "";
      for (var j = 0; j < numEntries; j++) {
        for (var i = 0; i < 9; i++) {
          value_unshuffled += value[numEntries*i + j];
        }
      }
      return value_unshuffled;
    } else {
      return value;
    }
  }

  this.paramsFromStandardURL = function () {
    var urlParams = new URLSearchParams(window.location.search);
    var entries = urlParams.entries();
    var map = {};
    for (var entry of entries) {
      map[entry[0]] = entry[1];
    }
    return map;
  }

  this.paramsFromCompactURL = function () {
    var param = self.paramsFromStandardURL()["a"];
    var map = {};
    if (param != null) {
      var ps = self.unshuffleParam(param);
      if (ps != null) {
        if (ps.length == 9 || ps.length == 27) {  // Key is in the URL.
          if (ps.length >= 9) {
            map["a"] = ps.slice(0, 9);
          }
          if (ps.length == 27) {
            map["this"] = ps.slice(9, 18);
            map["other"] = ps.slice(18, 27);
          }
        } else if (ps.length == 18) { // Key is in the configuration.
          map["a"] = self.app.config.key;
          map["this"] = ps.slice(0, 9);
          map["other"] = ps.slice(9, 18);
        }
      }
    }
    return map;
  }

  // Toggle based on type of URL.
  this.paramsFromURL = this.paramsFromCompactURL;

  this.authFromURL = function () {
    var param = self.paramsFromURL()["a"];
    var auth = self.unshuffleParam(param);
    if (auth != null) {
      auth = (auth[0] == "H") ? auth : ("H" + auth.slice(1, 9));
    }
    return auth;
  }

  this.allowSimulatedFromURL = function () {
    var ps = self.paramsFromURL();
    return
      (!"key" in self.app.config) && // Only toggle via URL if key is from URL.
      ("a" in ps) && (self.unshuffleParam(ps["a"])[0] == "H");
  }

  this.idsFromURL = function () {
    var params = self.paramsFromURL();
    if (params["this"] != null && params["other"] != null) {
      self.app.state.idSelf(params["this"]);
      self.app.state.idOther(params["other"]);
      return true;
    }
    return false;
  };

  this.validURL = function () {
    var urlParams = new URLSearchParams(window.location.search);
    var entries = urlParams.entries();
    var parameters = [];
    for (var entry of entries) {
      if (entry[0] != "ref") {
        parameters.push({"name":entry[0], "value": entry[1]});
      }
    }
    if (parameters.length == 0) {
      return true;
    } else if (
         parameters.length != 1
      || parameters[0].name != "a"
      || (
           parameters[0].value.length != 9
        && parameters[0].value.length != 18
        && parameters[0].value.length != 27
         )
       ) {
      return false;
    }

    return true;
  }

  this.isContributorURL = function () {
    var urlParams = new URLSearchParams(window.location.search);
    var entries = urlParams.entries();
    var parameters = [];
    for (var entry of entries) {
      if (entry[0] != "ref") {
        parameters.push({"name":entry[0], "value": entry[1]});
      }
    }
    return (
         parameters.length == 1
      && parameters[0].name == "a"
      && (parameters[0].value.length == 27 || parameters[0].value.length == 18)
    );
  }

  this.contributorStandardURL = function () {
    var url = window.location.protocol + "//" + window.location.host + window.location.pathname;
    return url + "?" + [
      "a="+self.paramsFromURL()["a"],
      "this="+self.app.state.idOther(),
      "other="+self.app.state.idSelf()
    ].join("&");
  };

  this.contributorCompactURL = function () {
    var url = window.location.protocol + "//" + window.location.host + window.location.pathname;
    return url + "?a=" +
      self.shuffleParam(
        (("key" in self.app.config) ? "" : self.paramsFromURL()["a"]) +
        self.app.state.idOther() +
        self.app.state.idSelf()
      );
  };

  // Toggle based on type of URL.
  this.contributorURL = this.contributorCompactURL;
}

const app = new App({
  "domain": "nth.associates",
  "version": "alpha",
  "tagline": "The easy and safe way to <b>enrich data</b> without decrypting it in the process.",
  "collection": "nth-link",
  "maximumCSVFileSize": "50 * 1024 * 1024",
  "maximumCSVRowCount": 100000,
  "operations": {
    "toggleFirstRow": true,
    "domain": false,
    "join": true,
    "groupBy": false
  },
  "services": {
    "url": "https://api.nth.associates/bwqc0s25CZ8",
    "key": "bbiqV1Xb0EPmS7PpGGtBx1r1WMvNROBWHe4S6y76"
  },
  "simulatedDataSizes": [
    50,
    500,
    5000
  ],
  "socialMediaSharing": false,
  "signup": false,
  "analysisResultsFeedbackSurveyLink": false,
  "offboard": false,
  "offboardEmbeddedFeedbackSurvey": false,
  "obfuscate": false,
  "gtagId": "G-YYFNCX1979",
  "key": "HYqNO2iUl"
});
    </script>
  </body>
</html>